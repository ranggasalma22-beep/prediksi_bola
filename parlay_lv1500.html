<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PSZ LEVEL 1500 - FULL POWER MODE</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #0d1117;
        color: #e6edf3;
        margin: 0;
        padding: 0;
        display: flex;
        height: 100vh;
        overflow: hidden;
    }
    #leftPanel {
        width: 28%;
        background: #161b22;
        padding: 20px;
        overflow-y: auto;
        border-right: 2px solid #30363d;
    }
    #rightPanel {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 20px;
        overflow-y: auto;
    }
    .sectionTitle {
        font-size: 18px;
        margin: 20px 0 10px;
        font-weight: bold;
        border-bottom: 1px solid #30363d;
        padding-bottom: 5px;
    }
    select, input {
        width: 100%;
        padding: 6px;
        margin: 6px 0;
        border-radius: 6px;
        border: none;
        background: #21262d;
        color: #e6edf3;
    }
    button {
        width: 100%;
        padding: 10px;
        background: #238636;
        border: none;
        border-radius: 6px;
        margin-top: 12px;
        color: white;
        font-weight: bold;
        cursor: pointer;
    }
    button:hover {
        background: #2ea043;
    }
    #output {
        flex: 1;
        white-space: pre-wrap;
        background: #0d1117;
        border: 1px solid #30363d;
        padding: 10px;
        margin-top: 10px;
        border-radius: 6px;
        overflow-y: auto;
    }
</style>
</head>
<body>

<div id="leftPanel">
    <div class="sectionTitle">Match Input</div>

    <label>Expected Goals (Home)</label>
    <input id="xg_home" type="number" step="0.01">

    <label>Expected Goals (Away)</label>
    <input id="xg_away" type="number" step="0.01">

    <label>Shots (Home)</label>
    <input id="shots_home" type="number">

    <label>Shots (Away)</label>
    <input id="shots_away" type="number">

    <label>SOT (Home)</label>
    <input id="sot_home" type="number">

    <label>SOT (Away)</label>
    <input id="sot_away" type="number">

    <label>Possession Home (%)</label>
    <input id="pos_home" type="number">

    <label>Importance (1–10)</label>
    <input id="importance" type="number" min="1" max="10">

    <div class="sectionTitle">Match Type (57 Types)</div>
    <select id="match_type">
        <!-- Will be filled in PART 2 -->
    </select>
<!-- =========================
     ADVANCED CONTEXT PRESET
     ========================= -->
<div class="sectionTitle">Advanced Context Preset</div>

<label>League Preset</label>
<select id="league_preset">
  <option value="AUTO">AUTO (Engine)</option>
  <option value="EPL">Premier League</option>
  <option value="BUNDES">Bundesliga</option>
  <option value="SERIEA">Serie A</option>
  <option value="LALIGA">LaLiga</option>
  <option value="LIGUE1">Ligue 1</option>
  <option value="EREDIV">Eredivisie</option>
  <option value="UCL">UCL / Continental</option>
  <option value="CUP">Cup / Knockout</option>
</select>

<label>Home Team Tier</label>
<select id="home_tier">
  <option value="AUTO">AUTO (Engine)</option>
  <option value="BIG">BIG Team</option>
  <option value="MID">MID Table</option>
  <option value="SMALL">SMALL / Underdog</option>
</select>

<label>Away Team Tier</label>
<select id="away_tier">
  <option value="AUTO">AUTO (Engine)</option>
  <option value="BIG">BIG Team</option>
  <option value="MID">MID Table</option>
  <option value="SMALL">SMALL / Underdog</option>
</select>

    <button id="runEngine">RUN ANALYSIS</button>
</div>

<div id="rightPanel">
    <div class="sectionTitle">PSZ LEVEL 1500 — RESULT</div>
    <div id="output">Waiting for input…</div>
</div>
<script>
/* ======================================================
   PART 2 — MATCH TYPE REGISTRY (57 TYPES)
   Level 1500 — Full Power
   ====================================================== */

window.PSZ = window.PSZ || {};
(function(PSZ){

  /* ============================
     1. MATCH TYPE LIST (57)
ya     ============================ */
  PSZ.MATCH_TYPES = [
    // I. Domestic League
    { id:"league_standard", label:"League — Standard" },
    { id:"league_big_match", label:"League — Big Match" },
    { id:"league_relegation_fight", label:"League — Relegation Fight" },
    { id:"league_title_decider", label:"League — Title Decider" },
    { id:"league_low_stakes", label:"League — Low Stakes" },

    // II. Cup
    { id:"cup_knockout_early", label:"Cup — Knockout (Early Round)" },
    { id:"cup_quarter_final", label:"Cup — Quarter Final" },
    { id:"cup_semi_final", label:"Cup — Semi Final" },
    { id:"cup_final", label:"Cup — Final" },
    { id:"cup_first_leg", label:"Cup — First Leg" },
    { id:"cup_second_leg", label:"Cup — Second Leg" },
    { id:"cup_away_goal_rule", label:"Cup — Away Goal Rule" },

    // III. Continental
    { id:"ucl_group", label:"UCL — Group Stage" },
    { id:"ucl_knockout", label:"UCL — Knockout" },
    { id:"ucl_quarter", label:"UCL — Quarter Final" },
    { id:"ucl_semi", label:"UCL — Semi Final" },
    { id:"ucl_final", label:"UCL — Final" },

  = PSZ.num(document.getElementById("xg_away")?.value, 1.0);
    const shH   = PSZ.num(document.getElementById("shots_home")?.value, 12);
    const shA   = PSZ.num(document.getElementById("shots_away")?.value, 10);
    const sotH  = PSZ.num(document.getElementById("sot_home")?.value, 4);
    const sotA  = PSZ.num(document.getElementById("sot_away")?.value, 3);
    const posH  = PSZ.num(document.getElementById("pos_home")?.value, 50);
    const imp   = PSZ.num(document.getElementById("importance")?.value, 5);

    const shotsTotal = shH + shA;

    /* ============================
       AUTO PRESSING
       ============================ */
    let pressH = 5
      + (shA - shH) * 0.12
      + (50 - posH) * 0.06
      + (sotA - sotH) * 0.18;

    let pressA = 5
      + (shH - shA) * 0.12
      + (posH - 50) * 0.06
      + (sotH - sotA) * 0.18;

    pressH = PSZ.clamp(pressH, 1, 9);
    pressA = PSZ.clamp(pressA, 1, 9);

    /* ============================
       AUTO PPDA
       ============================ */
    let ppdaH = 14 - pressH*0.9 + (posH - 50)*0.05;
    let ppdaA = 14 - pressA*0.9 + (50 - posH)*0.05;

    ppdaH = PSZ.clamp(ppdaH, 5, 25);
    ppdaA = PSZ.clamp(ppdaA, 5, 25);

    const avgPPDA = (ppdaH + ppdaA) / 2;

    /* ============================
       AUTO TEMPO
       ============================ */
    let tempo = 5
      + (shotsTotal / 20)
      + (pressH + pressA - 10) * 0.15
      + (12 - avgPPDA) * 0.08
      - (imp - 5) * 0.25;

    tempo = PSZ.clamp(tempo, 1, 9);

    /* ============================
       AUTO VOLATILITY (CHAOS)
       ============================ */
    let volatility = 0.5
      + (tempo - 5) * 0.12
      + Math.abs(pressH - pressA) * 0.10
      + Math.abs(posH - 50) / 50 * 0.4;

    volatility = PSZ.clamp(volatility, 0.3, 1.0);

    /* ============================
       AUTO RISK
       ============================ */
    let risk = volatility * 0.5
      + tempo / 10
      + (pressH + pressA) / 20;

    risk = PSZ.clamp(risk, 0, 1);

    /* ============================
       AUTO PARKIR BUS
       ============================ */
    const parkHome = (xgA - xgH > 0.7) || (imp > 7 && posH < 45);
    const parkAway = (xgH - xgA > 0.7) || (imp > 7 && posH > 55);

    /* ============================
       AUTO STAMINA BASELINE
       ============================ */
    const staminaH = PSZ.clamp(1 - (pressH - 5)*0.03 - (tempo - 5)*0.02, 0.6, 1);
    const staminaA = PSZ.clamp(1 - (pressA - 5)*0.03 - (tempo - 5)*0.02, 0.6, 1);

    /* ============================
       MATCH TYPE (AUTO OR MANUAL)
       ============================ */
    const mtSel = document.getElementById("match_type")?.value || "AUTO";
    const matchType = (mtSel === "AUTO")
      ? PSZ.autoDetectMatchType({ importance:imp, shots_home:shH, shots_away:shA })
      : mtSel;

    /* ============================
       FINAL CONTEXT
       ============================ */
    return {
      base:{
        xgH, xgA, shH, shA, sotH, sotA, posH, imp
      },
      auto:{
        pressH, pressA,
        ppdaH, ppdaA,
        tempo,
        volatility,
        risk,
        parkHome, parkAway,
        staminaH, staminaA,
        matchType
      }
    };
  };

  console.log("PART 3 loaded: Auto Input Engine (FULL AUTO)");

})(window.PSZ);
</script>
<script>
/* ======================================================
   PART 3.5 — PRESET LIGA + PRESET TIM (REBUILD)
   ====================================================== */

window.PSZ = window.PSZ || {};
(function(PSZ){

  // ===== League Preset =====
  PSZ.LEAGUE_PRESETS = {
    EPL:    { tempo: 0.6, press: 0.7, vol: 0.12 },
    BUNDES: { tempo: 0.8, press: 0.5, vol: 0.15 },
    SERIEA: { tempo:-0.4, press:-0.2, vol:-0.10 },
    LALIGA: { tempo:-0.3, press:-0.1, vol:-0.08 },
    LIGUE1: { tempo: 0.1, press: 0.2, vol: 0.05 },
    EREDIV: { tempo: 0.9, press: 0.6, vol: 0.18 },
    UCL:    { tempo: 0.3, press: 0.4, vol: 0.10 },
    CUP:    { tempo:-0.5, press:-0.3, vol:-0.12 }
  };

  // ===== Team Tier Preset =====
  PSZ.TEAM_PRESETS = {
    BIG:   { tempo: 0.3, press: 0.5, risk:-0.10, vol:-0.05 },
    MID:   { tempo: 0.0, press: 0.0, risk: 0.00, vol: 0.00 },
    SMALL: { tempo:-0.3, press:-0.4, risk: 0.15, vol: 0.10 }
  };

  // ===== Auto Team Tier (SINGLE SOURCE) =====
  PSZ.autoTeamTier = function(xg, shots){
    if(xg >= 1.8 && shots >= 14) return "BIG";
    if(xg <= 0.9 && shots <= 9)  return "SMALL";
    return "MID";
  };

  // ===== Apply Context Preset =====
  PSZ.applyContextPresets = function(ctx, leagueKey, homeTier, awayTier){
    if(!ctx || !ctx.auto) return;
    const clamp = PSZ.clamp;

    // League
    const L = PSZ.LEAGUE_PRESETS[leagueKey];
    if(L){
      ctx.auto.tempo      = clamp(ctx.auto.tempo + L.tempo, 1, 9);
      ctx.auto.pressH     = clamp(ctx.auto.pressH + L.press, 1, 9);
      ctx.auto.pressA     = clamp(ctx.auto.pressA + L.press, 1, 9);
      ctx.auto.volatility = clamp(ctx.auto.volatility + L.vol, 0.3, 1);
    }

    // Home
    const TH = PSZ.TEAM_PRESETS[homeTier] || PSZ.TEAM_PRESETS.MID;
    ctx.auto.tempo      = clamp(ctx.auto.tempo + TH.tempo, 1, 9);
    ctx.auto.pressH     = clamp(ctx.auto.pressH + TH.press, 1, 9);
    ctx.auto.risk       = clamp(ctx.auto.risk + TH.risk, 0, 1);
    ctx.auto.volatility = clamp(ctx.auto.volatility + TH.vol, 0.3, 1);

    // Away
    const TA = PSZ.TEAM_PRESETS[awayTier] || PSZ.TEAM_PRESETS.MID;
    ctx.auto.tempo      = clamp(ctx.auto.tempo + TA.tempo, 1, 9);
    ctx.auto.pressA     = clamp(ctx.auto.pressA + TA.press, 1, 9);
    ctx.auto.risk       = clamp(ctx.auto.risk + TA.risk, 0, 1);
    ctx.auto.volatility = clamp(ctx.auto.volatility + TA.vol, 0.3, 1);
  };

})(window.PSZ);
</script>

<script>
/* ======================================================
   PART 4 — CORE ENGINE
   Level 1500 — Dynamic λ, fxG, Stamina Decay
   ====================================================== */

window.PSZ = window.PSZ || {};
(function(PSZ){

  /* ============================
     Math helpers
     ============================ */
  PSZ.poissonPMF = function(lambda, k){
    if(lambda <= 0) return (k===0 ? 1 : 0);
    let p = Math.exp(-lambda);
    for(let i=1;i<=k;i++) p *= lambda / i;
    return p;
  };

  /* ============================
     Dynamic Lambda Builder
     ============================ */
  PSZ.buildDynamicLambda = function(ctx){
    const { xgH, xgA } = ctx.base;
    const A = ctx.auto;

    let lamH = xgH;
    let lamA = xgA;

    // tempo & volatility
    lamH *= (1 + (A.tempo - 5) * 0.06 + (A.volatility - 0.5) * 0.25);
    lamA *= (1 + (A.tempo - 5) * 0.06 + (A.volatility - 0.5) * 0.25);

    // pressing advantage
    lamH *= (1 + (A.pressH - A.pressA) * 0.04);
    lamA *= (1 + (A.pressA - A.pressH) * 0.04);

    // park the bus dampening
    if(A.parkHome) lamH *= 0.88;
    if(A.parkAway) lamA *= 0.88;

    lamH = PSZ.clamp(lamH, 0.2, 4.5);
    lamA = PSZ.clamp(lamA, 0.2, 4.5);

    return { lamH, lamA };
  };

  /* ============================
     fxG — Forced Error Goals
     ============================ */
  PSZ.computeFxG = function(ctx){
    const A = ctx.auto;

    const fatigueH = 1 - A.staminaH;
    const fatigueA = 1 - A.staminaA;

    const fxgH = PSZ.clamp(
      (A.pressH/10) * fatigueA * (0.5 + A.volatility),
      0, 0.6
    );

    const fxgA = PSZ.clamp(
      (A.pressA/10) * fatigueH * (0.5 + A.volatility),
      0, 0.6
    );

    return { fxgH, fxgA };
  };

  /* ============================
     Minute-by-minute stamina decay
     ============================ */
  PSZ.simulateStamina = function(stamina0, press, tempo){
    let stamina = stamina0;
    for(let m=1;m<=90;m++){
      let decay = 0.002;
      decay += (press - 5) * 0.0009;
      decay += (tempo - 5) * 0.0006;
      if(m >= 70) decay *= 1.8; // late spike
      stamina -= decay;
    }
    return PSZ.clamp(stamina, 0.3, 1);
  };

  /* ============================
     Apply stamina decay + fxG to lambda
     ============================ */
  PSZ.applyFatigueAndFxG = function(ctx, baseLam){
    const A = ctx.auto;

    const endStaminaH = PSZ.simulateStamina(A.staminaH, A.pressH, A.tempo);
    const endStaminaA = PSZ.simulateStamina(A.staminaA, A.pressA, A.tempo);

    const lateErrorBoostH = (1 - endStaminaA) * 0.35;
    const lateErrorBoostA = (1 - endStaminaH) * 0.35;

    const fxg = PSZ.computeFxG(ctx);

    let lamH = baseLam.lamH + fxg.fxgH + lateErrorBoostH;
    let lamA = baseLam.lamA + fxg.fxgA + lateErrorBoostA;

    lamH = PSZ.clamp(lamH, 0.2, 5.2);
    lamA = PSZ.clamp(lamA, 0.2, 5.2);

    return {
      lamH, lamA,
      endStaminaH, endStaminaA,
      fxg
    };
  };

  console.log("PART 4 loaded: Core Engine (Dynamic λ + fxG + Stamina)");

})(window.PSZ);
</script>
<script>
/* ======================================================
   PART 5 — MONTE CARLO ENGINE (NON-WORKER)
   Level 1500 — Score Matrix, H/D/A, BTTS
   ====================================================== */

window.PSZ = window.PSZ || {};
(function(PSZ){

  /* ============================
     Poisson sampler
     ============================ */
  PSZ.poissonSample = function(lambda){
    if(lambda <= 0) return 0;
    const L = Math.exp(-lambda);
    let k = 0, p = 1;
    do { k++; p *= Math.random(); } while(p > L);
    return k - 1;
  };

  /* ============================
     Monte Carlo Simulation
     ============================ */
  PSZ.runMonteCarlo = function(ctx, options){
    options = options || {};
    const N = options.N || 8000;   // aman untuk browser
    const CAP = options.cap || 6;

    // 1) Dynamic lambda + fatigue + fxG
    const baseLam = PSZ.buildDynamicLambda(ctx);
    const adjLam  = PSZ.applyFatigueAndFxG(ctx, baseLam);
    const lamH = adjLam.lamH;
    const lamA = adjLam.lamA;

    // 2) Init matrix
    const mat = {};
    for(let h=0; h<=CAP; h++){
      mat[h] = {};
      for(let a=0; a<=CAP; a++) mat[h][a] = 0;
    }

    // 3) Counters
    let homeWin=0, draw=0, awayWin=0;
    let btts=0, sumGoals=0;

    // 4) Run MC
    for(let i=0;i<N;i++){
      const gh = PSZ.poissonSample(lamH);
      const ga = PSZ.poissonSample(lamA);

      if(gh<=CAP && ga<=CAP) mat[gh][ga]++;

      if(gh > ga) homeWin++;
      else if(gh === ga) draw++;
      else awayWin++;

      if(gh>0 && ga>0) btts++;
      sumGoals += (gh + ga);
    }

    // 5) Normalize probs
    const pH = homeWin / N;
    const pD = draw / N;
    const pA = awayWin / N;
    const pBTTS = btts / N;
    const avgGoals = sumGoals / N;

    // 6) Top Correct Score
    const cs = [];
    for(let h=0; h<=CAP; h++){
      for(let a=0; a<=CAP; a++){
        const p = mat[h][a] / N;
        if(p>0) cs.push({score:`${h}-${a}`, p});
      }
    }
    cs.sort((x,y)=>y.p - x.p);
    const topCS = cs.slice(0,5);

    return {
      params:{
        lamH, lamA,
        endStaminaH: adjLam.endStaminaH,
        endStaminaA: adjLam.endStaminaA,
        fxg: adjLam.fxg
      },
      matrix: mat,
      probs:{ pH, pD, pA },
      BTTS: pBTTS,
      avgGoals,
      topCS,
      meta:{
        N, CAP,
        matchType: ctx.auto.matchType,
        tempo: ctx.auto.tempo,
        volatility: ctx.auto.volatility,
        risk: ctx.auto.risk
      }
    };
  };

  console.log("PART 5 loaded: Monte Carlo Engine");

})(window.PSZ);
</script>
<script>
/* ======================================================
   PART 6 — OUTPUT BUILDER & UI BINDING
   Level 1500 — FINAL RESULT DISPLAY
   ====================================================== */

window.PSZ = window.PSZ || {};
(function(PSZ){

  /* ============================
     Output Formatter
     ============================ */
  PSZ.buildOutputText = function(ctx, res){
    let t = "";
    t += "=== PSZ LEVEL 1500 — FULL POWER MODE ===\n\n";

    // Match Info
    t += "[MATCH INFO]\n";
    t += "Match Type   : " + ctx.auto.matchType + "\n";
    t += "Importance   : " + ctx.base.imp + "\n";
    t += "Tempo (Auto) : " + ctx.auto.tempo.toFixed(2) + "\n";
    t += "Volatility   : " + ctx.auto.volatility.toFixed(2) + "\n";
    t += "Risk Level   : " + ctx.auto.risk.toFixed(2) + "\n\n";

    // Lambda & fatigue
    t += "[ENGINE CORE]\n";
    t += "λ Home       : " + res.params.lamH.toFixed(3) + "\n";
    t += "λ Away       : " + res.params.lamA.toFixed(3) + "\n";
    t += "End Stamina H: " + res.params.endStaminaH.toFixed(2) + "\n";
    t += "End Stamina A: " + res.params.endStaminaA.toFixed(2) + "\n";
    t += "fxG Home     : " + res.params.fxg.fxgH.toFixed(3) + "\n";
    t += "fxG Away     : " + res.params.fxg.fxgA.toFixed(3) + "\n\n";

    // Probabilities
    t += "[PROBABILITIES]\n";
    t += "Home Win : " + (res.probs.pH*100).toFixed(1) + "%\n";
    t += "Draw     : " + (res.probs.pD*100).toFixed(1) + "%\n";
    t += "Away Win : " + (res.probs.pA*100).toFixed(1) + "%\n\n";

    // Goals
    t += "[GOALS]\n";
    t += "BTTS      : " + (res.BTTS*100).toFixed(1) + "%\n";
    t += "Avg Goals : " + res.avgGoals.toFixed(2) + "\n\n";

    // Correct Score
    t += "[TOP CORRECT SCORE]\n";
    res.topCS.forEach(cs=>{
      t += cs.score + " → " + (cs.p*100).toFixed(2) + "%\n";
    });

    t += "\n[ENGINE NOTE]\n";
    t += "- All tactical inputs are AUTO generated\n";
    t += "- Pressing, PPDA, Tempo, Risk, Stamina = ENGINE\n";
    t += "- fxG & late error spike applied\n";

    return t;
  };

  /* ============================
     RUN BUTTON HANDLER
     ============================ */
  PSZ.runAnalysis = function(){
  try{
    const ctx = PSZ.buildAutoContext();

    // ===== Context Preset (FINAL) =====
    const leagueSel = document.getElementById("league_preset")?.value || "AUTO";
    let leagueKey = leagueSel;

    if(leagueSel === "AUTO"){
      leagueKey = ctx.auto.matchType.includes("ucl") ? "UCL"
               : ctx.auto.matchType.includes("cup") ? "CUP"
               : "EPL";
    }

    const homeTierSel = document.getElementById("home_tier")?.value || "AUTO";
    const awayTierSel = document.getElementById("away_tier")?.value || "AUTO";

    const homeTier = (homeTierSel === "AUTO")
      ? PSZ.autoTeamTier(ctx.base.xgH, ctx.base.shH)
      : homeTierSel;

    const awayTier = (awayTierSel === "AUTO")
      ? PSZ.autoTeamTier(ctx.base.xgA, ctx.base.shA)
      : awayTierSel;

    PSZ.applyContextPresets(ctx, leagueKey, homeTier, awayTier);

    ctx.auto.leaguePreset = leagueKey;
    ctx.auto.homeTier = homeTier;
    ctx.auto.awayTier = awayTier;

    // ===== Run Engine =====
    const res = PSZ.runMonteCarlo(ctx);

    document.getElementById("output").value =
      PSZ.buildOutputText(ctx, res);

  }catch(e){
    document.getElementById("output").value =
      "ERROR:\n" + e.message;
    console.error(e);
  }
};

  /* ============================
     Bind Button
     ============================ */
  document.addEventListener("DOMContentLoaded", function(){
    const btn = document.getElementById("runEngine");
    if(btn){
      btn.addEventListener("click", PSZ.runAnalysis);
    }
  });

  console.log("PART 6 loaded: Output Builder + Run Binding");

})(window.PSZ);
</script>
<script>
/* ======================================================
   PART 7 — MATCH ARCHETYPE CLASSIFIER
   Level 1500 — Tactical Intelligence Layer
   ====================================================== */

window.PSZ = window.PSZ || {};
(function(PSZ){

  /* ============================
     Archetype Detection
     ============================ */
  PSZ.detectArchetype = function(ctx){
    const A = ctx.auto;
    const B = ctx.base;

    const pressDiff = Math.abs(A.pressH - A.pressA);
    const tempo = A.tempo;
    const vol = A.volatility;
    const posDiff = Math.abs(B.posH - 50);
    const shots = B.shH + B.shA;

    if(tempo >= 7.5 && vol >= 0.75 && shots >= 26)
      return "Chaos / Run & Gun";

    if(tempo <= 4 && vol <= 0.45 && shots <= 16)
      return "Slow Tactical / Low Event";

    if(A.pressH >= 7 && A.pressA >= 7)
      return "High Press Duel";

    if(posDiff >= 15 && shots <= 20)
      return "Possession vs Low Block";

    if(A.parkHome || A.parkAway)
      return "Defensive / Park The Bus";

    return "Balanced / Standard";
  };

  /* ============================
     Apply Archetype Modifiers
     ============================ */
  PSZ.applyArchetypeModifiers = function(ctx, lam){
    const arche = PSZ.detectArchetype(ctx);

    let lamH = lam.lamH;
    let lamA = lam.lamA;

    switch(arche){
      case "Chaos / Run & Gun":
        lamH *= 1.08;
        lamA *= 1.08;
        break;

      case "Slow Tactical / Low Event":
        lamH *= 0.92;
        lamA *= 0.92;
        break;

      case "High Press Duel":
        lamH *= 1.04;
        lamA *= 1.04;
        break;

      case "Possession vs Low Block":
        if(ctx.auto.parkAway) lamH *= 1.05;
        if(ctx.auto.parkHome) lamA *= 1.05;
        break;

      case "Defensive / Park The Bus":
        lamH *= 0.94;
        lamA *= 0.94;
        break;
    }

    return {
      lamH: PSZ.clamp(lamH, 0.2, 5.5),
      lamA: PSZ.clamp(lamA, 0.2, 5.5),
      archetype: arche
    };
  };

  /* ============================
     Hook archetype into engine
     ============================ */
  const _origBuildDynamicLambda = PSZ.buildDynamicLambda;
  PSZ.buildDynamicLambda = function(ctx){
    const baseLam = _origBuildDynamicLambda(ctx);
    const modLam  = PSZ.applyArchetypeModifiers(ctx, baseLam);
    ctx.auto.archetype = modLam.archetype;
    return { lamH: modLam.lamH, lamA: modLam.lamA };
  };

  /* ============================
     Extend Output (safe patch)
     ============================ */
  const _origBuildOutputText = PSZ.buildOutputText;
  PSZ.buildOutputText = function(ctx, res){
    let t = _origBuildOutputText(ctx, res);
    t += "\n[ARCHETYPE]\n";
    t += ctx.auto.archetype + "\n";
    t += "- Archetype modifies tempo & λ adaptively\n";
    return t;
  };

  console.log("PART 7 loaded: Match Archetype Classifier");

})(window.PSZ);
</script>
<script>
/* ======================================================
   PART 8 — OU, CONFIDENCE & RECOMMENDATION
   Level 1500 — Final Enhancement
   ====================================================== */

window.PSZ = window.PSZ || {};
(function(PSZ){

  /* ============================
     Over / Under from MC Matrix
     ============================ */
  PSZ.computeOU = function(res){
    const lines = [0.5, 1.5, 2.5, 3.5];
    const out = {};
    const mat = res.matrix;
    const CAP = res.meta.CAP;
    const N = res.meta.N;

    lines.forEach(line=>{
      const cut = Math.floor(line);
      let under = 0;
      for(let h=0; h<=CAP; h++){
        for(let a=0; a<=CAP; a++){
          if(h + a <= cut) under += mat[h][a];
        }
      }
      out[line] = {
        under: under / N,
        over: 1 - (under / N)
      };
    });

    return out;
  };

  /* ============================
     Confidence Score
     ============================ */
  PSZ.computeConfidence = function(ctx, res){
    const pMax = Math.max(res.probs.pH, res.probs.pD, res.probs.pA);
    let conf = pMax * 100;

    // penalty for chaos & high risk
    conf -= ctx.auto.volatility * 15;
    conf -= ctx.auto.risk * 10;

    // bonus for strong signal
    if(pMax >= 0.55) conf += 5;
    if(pMax >= 0.60) conf += 5;

    return PSZ.clamp(conf, 35, 95);
  };

  /* ============================
     Recommendation Builder
     ============================ */
  PSZ.buildRecommendation = function(ctx, res, ou, conf){
    let rec = {};

    // 1X2 lean
    if(res.probs.pH > res.probs.pD && res.probs.pH > res.probs.pA)
      rec.result = "LEAN HOME";
    else if(res.probs.pA > res.probs.pH && res.probs.pA > res.probs.pD)
      rec.result = "LEAN AWAY";
    else
      rec.result = "LEAN DRAW";

    // Goals lean (2.5 main)
    rec.goals = ou[2.5].over > 0.55 ? "OVER 2.5" : "UNDER 2.5";

    // BTTS lean
    rec.btts = res.BTTS > 0.55 ? "BTTS YES" : "BTTS NO";

    // Risk warning
    rec.warning = "NORMAL";
    if(ctx.auto.volatility >= 0.75 || ctx.auto.risk >= 0.75)
      rec.warning = "HIGH VARIANCE";
    if(conf < 45)
      rec.warning = "LOW CONFIDENCE";

    return rec;
  };

  /* ============================
     Patch Output Builder
     ============================ */
  const _origBuildOutputText = PSZ.buildOutputText;
PSZ.buildOutputText = function(ctx, res){
  let t = "";

  t += "=== ANALYSIS RESULT ===\n\n";

  t += "[PROBABILITIES]\n";
  t += "Home Win : " + (res.probs.pH*100).toFixed(1) + "%\n";
  t += "Draw     : " + (res.probs.pD*100).toFixed(1) + "%\n";
  t += "Away Win : " + (res.probs.pA*100).toFixed(1) + "%\n\n";

  t += "[GOALS]\n";
  t += "BTTS     : " + (res.BTTS*100).toFixed(1) + "%\n";
  t += "Avg Goal : " + res.avgGoals.toFixed(2) + "\n\n";

  t += "[CONTEXT PRESET]\n";
  t += "League    : " + ctx.auto.leaguePreset + "\n";
  t += "Home Tier : " + ctx.auto.homeTier + "\n";
  t += "Away Tier : " + ctx.auto.awayTier + "\n\n";

  t += "[TOP SCORE]\n";
  res.topCS.forEach(s=>{
    t += s.score + " (" + (s.p*100).toFixed(1) + "%)\n";
  });

  return t;
};
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PSZ LEVEL 1500 - FULL POWER MODE</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #0d1117;
        color: #e6edf3;
        margin: 0;
        padding: 0;
        display: flex;
        height: 100vh;
        overflow: hidden;
    }
    #leftPanel {
        width: 28%;
        background: #161b22;
        padding: 20px;
        overflow-y: auto;
        border-right: 2px solid #30363d;
    }
    #rightPanel {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 20px;
        overflow-y: auto;
    }
    .sectionTitle {
        font-size: 18px;
        margin: 20px 0 10px;
        font-weight: bold;
        border-bottom: 1px solid #30363d;
        padding-bottom: 5px;
    }
    select, input {
        width: 100%;
        padding: 6px;
        margin: 6px 0;
        border-radius: 6px;
        border: none;
        background: #21262d;
        color: #e6edf3;
    }
    button {
        width: 100%;
        padding: 10px;
        background: #238636;
        border: none;
        border-radius: 6px;
        margin-top: 12px;
        color: white;
        font-weight: bold;
        cursor: pointer;
    }
    button:hover {
        background: #2ea043;
    }
    #output {
        flex: 1;
        white-space: pre-wrap;
        background: #0d1117;
        border: 1px solid #30363d;
        padding: 10px;
        margin-top: 10px;
        border-radius: 6px;
        overflow-y: auto;
    }
</style>
</head>
<body>

<div id="leftPanel">
    <div class="sectionTitle">Match Input</div>

    <label>Expected Goals (Home)</label>
    <input id="xg_home" type="number" step="0.01">

    <label>Expected Goals (Away)</label>
    <input id="xg_away" type="number" step="0.01">

    <label>Shots (Home)</label>
    <input id="shots_home" type="number">

    <label>Shots (Away)</label>
    <input id="shots_away" type="number">

    <label>SOT (Home)</label>
    <input id="sot_home" type="number">

    <label>SOT (Away)</label>
    <input id="sot_away" type="number">

    <label>Preset Liga</label>
<select id="league_preset">
  <option value="AUTO">Auto Detect</option>

  <optgroup label="Top Leagues">
    <option value="EPL">Premier League (ENG)</option>
    <option value="LALIGA">La Liga (ESP)</option>
    <option value="SERIEA">Serie A (ITA)</option>
    <option value="BUNDES">Bundesliga (GER)</option>
    <option value="LIGUE1">Ligue 1 (FRA)</option>
  </optgroup>

  <optgroup label="Secondary">
    <option value="EREDIV">Eredivisie</option>
    <option value="PRIMEIRA">Primeira Liga</option>
    <option value="MLS">MLS</option>
  </optgroup>

  <optgroup label="Cups / International">
    <option value="UCL">Champions League</option>
    <option value="UEL">Europa League</option>
    <option value="INT">International Match</option>
  </optgroup>
</select>

    <label>Possession Home (%)</label>
    <input id="pos_home" type="number">

    <label>Importance (1â€“10)</label>
    <input id="importance" type="number" min="1" max="10">

    <div class="sectionTitle">Match Type (57 Types)</div>
    <select id="match_type">
        <!-- Will be filled in PART 2 -->
    </select>

    <button id="runEngine">RUN ANALYSIS</button>
</div>

<div id="rightPanel">
    <div class="sectionTitle">PSZ LEVEL 1500 â€” RESULT</div>
    <div id="output">Waiting for inputâ€¦</div>
</div>
<script>
/* ======================================================
   PART 2 â€” MATCH TYPE REGISTRY (57 TYPES)
   Level 1500 â€” Full Power
   ====================================================== */

window.PSZ = window.PSZ || {};
(function(PSZ){

  /* ============================
     1. MATCH TYPE LIST (57)
     ============================ */
  PSZ.MATCH_TYPES = [
    // I. Domestic League
    { id:"league_standard", label:"League â€” Standard" },
    { id:"league_big_match", label:"League â€” Big Match" },
    { id:"league_relegation_fight", label:"League â€” Relegation Fight" },
    { id:"league_title_decider", label:"League â€” Title Decider" },
    { id:"league_low_stakes", label:"League â€” Low Stakes" },

    // II. Cup
    { id:"cup_knockout_early", label:"Cup â€” Knockout (Early Round)" },
    { id:"cup_quarter_final", label:"Cup â€” Quarter Final" },
    { id:"cup_semi_final", label:"Cup â€” Semi Final" },
    { id:"cup_final", label:"Cup â€” Final" },
    { id:"cup_first_leg", label:"Cup â€” First Leg" },
    { id:"cup_second_leg", label:"Cup â€” Second Leg" },
    { id:"cup_away_goal_rule", label:"Cup â€” Away Goal Rule" },

    // III. Continental
    { id:"ucl_group", label:"UCL â€” Group Stage" },
    { id:"ucl_knockout", label:"UCL â€” Knockout" },
    { id:"ucl_quarter", label:"UCL â€” Quarter Final" },
    { id:"ucl_semi", label:"UCL â€” Semi Final" },
    { id:"ucl_final", label:"UCL â€” Final" },

    { id:"uel_group", label:"UEL â€” Group Stage" },
    { id:"uel_knockout", label:"UEL â€” Knockout" },
    { id:"uel_final", label:"UEL â€” Final" },

    { id:"uecl_group", label:"UECL â€” Group Stage" },
    { id:"uecl_knockout", label:"UECL â€” Knockout" },

    { id:"libertadores_group", label:"Libertadores â€” Group" },
    { id:"libertadores_knockout", label:"Libertadores â€” Knockout" },
    { id:"libertadores_final", label:"Libertadores â€” Final" },

    { id:"afc_group", label:"AFC Champions League â€” Group" },
    { id:"afc_knockout", label:"AFC Champions League â€” Knockout" },

    // IV. Derby & Rivalry
    { id:"derby_city", label:"Derby â€” City" },
    { id:"derby_historic", label:"Derby â€” Historic" },
    { id:"derby_regional", label:"Derby â€” Regional" },
    { id:"derby_religious", label:"Derby â€” Religious" },
    { id:"derby_political", label:"Derby â€” Political" },

    // V. Match Style
    { id:"tactical_slow_game", label:"Style â€” Tactical Slow Game" },
    { id:"high_press_duel", label:"Style â€” High Press Duel" },
    { id:"run_and_gun", label:"Style â€” Run & Gun" },
    { id:"chaos_game", label:"Style â€” Chaos Match" },
    { id:"heavy_low_block", label:"Style â€” Heavy Low Block" },
    { id:"counter_vs_possession", label:"Style â€” Counter vs Possession" },
    { id:"long_ball_battle", label:"Style â€” Long Ball Battle" },

    // VI. Situational
    { id:"must_win_match", label:"Situational â€” Must Win" },
    { id:"dead_rubber", label:"Situational â€” Dead Rubber" },
    { id:"rotation_heavy", label:"Situational â€” Heavy Rotation" },
    { id:"injury_crisis_match", label:"Situational â€” Injury Crisis" },
    { id:"early_red_card_game", label:"Situational â€” Early Red Card" },
    { id:"weather_extreme_rain", label:"Weather â€” Heavy Rain" },
    { id:"weather_extreme_heat", label:"Weather â€” Extreme Heat" },
    { id:"bad_pitch_condition", label:"Pitch â€” Bad Condition" },
    { id:"crowd_high_pressure", label:"Crowd â€” High Pressure" },
    { id:"crowd_low_energy", label:"Crowd â€” Low Energy" },

    // VII. Special / Global
    { id:"friendly_match", label:"Friendly Match" },
    { id:"pre_season_friendly", label:"Pre-Season Friendly" },
    { id:"training_match", label:"Training Match" },
    { id:"all_star_match", label:"All Star Match" },
    { id:"international_qualifier", label:"International Qualifier" },
    { id:"world_cup_knockout", label:"World Cup â€” Knockout" },
    { id:"world_cup_final", label:"World Cup â€” Final" },
    { id:"club_world_cup_game", label:"Club World Cup" }
  ];

  /* ============================
     2. POPULATE DROPDOWN
     ============================ */
  PSZ.populateMatchType = function(){
    const sel = document.getElementById("match_type");
    if(!sel) return;

    sel.innerHTML = "";
    const autoOpt = document.createElement("option");
    autoOpt.value = "AUTO";
    autoOpt.textContent = "AUTO (Engine Decide)";
    sel.appendChild(autoOpt);

    PSZ.MATCH_TYPES.forEach(mt=>{
      const opt = document.createElement("option");
      opt.value = mt.id;
      opt.textContent = mt.label;
      sel.appendChild(opt);
    });
  };

  /* ============================
     3. AUTO MATCH TYPE CLASSIFIER (TEMPLATE)
     (akan dipakai engine di PART 7)
     ============================ */
  PSZ.autoDetectMatchType = function(ctx){
    const imp = ctx.importance || 5;
    const shots = (ctx.shots_home||0) + (ctx.shots_away||0);

    if(imp >= 9) return "cup_final";
    if(imp >= 8) return "league_title_decider";
    if(imp <= 3) return "friendly_match";
    if(shots >= 28) return "run_and_gun";
    if(shots <= 14) return "tactical_slow_game";

    return "league_standard";
  };

  /* ============================
     4. INIT
     ============================ */
  document.addEventListener("DOMContentLoaded", function(){
    PSZ.populateMatchType();
  });

  

})(window.PSZ);
</script>
<script>
/* ======================================================
   PART 3 â€” AUTO INPUT ENGINE
   Level 1500 â€” FULL AUTO MODE
   ====================================================== */
PSZ.LEAGUE_PRESETS = {

  // ðŸ‡¬ðŸ‡§ Premier League (ENG)
  EPL: {
    tempo: 6.6,
    volatility: 0.62,
    overBias: 0.05,
    bttsBias: 0.06,
    riskMod: 0.04,
    confMin: 60
  },

  // ðŸ‡ªðŸ‡¸ La Liga (ESP)
  LALIGA: {
    tempo: 5.7,
    volatility: 0.48,
    overBias: -0.08,
    bttsBias: -0.05,
    riskMod: -0.12,
    confMin: 62
  },

  // ðŸ‡®ðŸ‡¹ Serie A (ITA)
  SERIEA: {
    tempo: 5.3,
    volatility: 0.45,
    overBias: -0.10,
    bttsBias: -0.08,
    riskMod: -0.15,
    confMin: 65
  },

  // ðŸ‡©ðŸ‡ª Bundesliga (GER)
  BUNDES: {
    tempo: 7.2,
    volatility: 0.75,
    overBias: 0.08,
    bttsBias: 0.10,
    riskMod: 0.06,
    confMin: 58
  },

  // ðŸ‡«ðŸ‡· Ligue 1 (FRA)
  LIGUE1: {
    tempo: 5.5,
    volatility: 0.46,
    overBias: -0.03,
    bttsBias: -0.02,
    riskMod: -0.08,
    confMin: 63
  },

  // ðŸ† Champions League
  UCL: {
    tempo: 5.8,
    volatility: 0.48,
    overBias: -0.08,
    bttsBias: -0.06,
    riskMod: -0.18,
    confMin: 68
  },

  // ðŸ† Europa League
  UEL: {
    tempo: 5.9,
    volatility: 0.55,
    overBias: -0.05,
    bttsBias: -0.03,
    riskMod: -0.10,
    confMin: 65
  },

  // ðŸŒ International Match
  INT: {
    tempo: 5.0,
    volatility: 0.40,
    overBias: -0.10,
    bttsBias: -0.15,
    riskMod: -0.25,
    confMin: 70
  }
};

window.PSZ = window.PSZ || {};
(function(PSZ){

  /* ============================
     Utility
     ============================ */
  PSZ.clamp = PSZ.clamp || function(v,min,max){
    if(!isFinite(v)) v = min;
    if(min!==undefined) v = Math.max(min,v);
    if(max!==undefined) v = Math.min(max,v);
    return v;
  };

  PSZ.num = PSZ.num || function(v,def){
    const n = Number(v);
    return isFinite(n) ? n : def;
  };
/* ============================
   AUTO IMPORTANCE
   ============================ */
PSZ.autoImportance = function(ctx){

  let imp = 5; // default league
  const mt = ctx.matchType || "";

  if(mt.includes("friendly")) imp = 2;
  if(mt.includes("league")) imp = 5;
  if(mt.includes("big")) imp = 6;
  if(mt.includes("relegation")) imp = 7;
  if(mt.includes("knockout")) imp = 8;
  if(mt.includes("semi")) imp = 9;
  if(mt.includes("final")) imp = 10;

  if(ctx.tablePressure === "high") imp += 1;
  if(ctx.oddsBalance === "even") imp += 1;
  if(ctx.oddsBalance === "heavy_fav") imp -= 0.5;
  if(ctx.isDerby) imp += 1;

  return PSZ.clamp(imp, 1, 10);
};
  /* ============================
     MAIN AUTO INPUT BUILDER
     ============================ */
  PSZ.buildAutoContext = function(){

    // ---- RAW INPUT (yang punya sumber) ----
    const xgH   = PSZ.num(document.getElementById("xg_home")?.value, 1.2);
    const xgA   = PSZ.num(document.getElementById("xg_away")?.value, 1.0);
    const shH   = PSZ.num(document.getElementById("shots_home")?.value, 12);
    const shA   = PSZ.num(document.getElementById("shots_away")?.value, 10);
    const sotH  = PSZ.num(document.getElementById("sot_home")?.value, 4);
    const sotA  = PSZ.num(document.getElementById("sot_away")?.value, 3);
    const posH  = PSZ.num(document.getElementById("pos_home")?.value, 50);
    let impInput = document.getElementById("importance")?.value;

// matchType BELUM ADA di sini â†’ pakai sementara
let tempMatchType =
  document.getElementById("match_type")?.value || "AUTO";

let imp = impInput
  ? PSZ.num(impInput, 5)   // MANUAL override
  : PSZ.autoImportance({
      matchType: tempMatchType,
      tablePressure: "high",   // nanti bisa auto
      oddsBalance: "even",     // nanti bisa auto
      isDerby: false
    });
const impSource = impInput ? "MANUAL" : "AUTO";
    const shotsTotal = shH + shA;

    /* ============================
       AUTO PRESSING
       ============================ */
    let pressH = 5
      + (shA - shH) * 0.12
      + (50 - posH) * 0.06
      + (sotA - sotH) * 0.18;

    let pressA = 5
      + (shH - shA) * 0.12
      + (posH - 50) * 0.06
      + (sotH - sotA) * 0.18;

    pressH = PSZ.clamp(pressH, 1, 9);
    pressA = PSZ.clamp(pressA, 1, 9);

    /* ============================
       AUTO PPDA
       ============================ */
    let ppdaH = 14 - pressH*0.9 + (posH - 50)*0.05;
    let ppdaA = 14 - pressA*0.9 + (50 - posH)*0.05;

    ppdaH = PSZ.clamp(ppdaH, 5, 25);
    ppdaA = PSZ.clamp(ppdaA, 5, 25);

    const avgPPDA = (ppdaH + ppdaA) / 2;

    /* ============================
       AUTO TEMPO
       ============================ */
    let tempo = 5
      + (shotsTotal / 20)
      + (pressH + pressA - 10) * 0.15
      + (12 - avgPPDA) * 0.08
      - (imp - 5) * 0.25;

    tempo = PSZ.clamp(tempo, 1, 9);

    /* ============================
       AUTO VOLATILITY (CHAOS)
       ============================ */
    let volatility = 0.5
      + (tempo - 5) * 0.12
      + Math.abs(pressH - pressA) * 0.10
      + Math.abs(posH - 50) / 50 * 0.4;

    volatility = PSZ.clamp(volatility, 0.3, 1.0);
const leagueKey =
  document.getElementById("league_preset")?.value || "AUTO";

let leagueRiskMod = 0;

if (leagueKey !== "AUTO" && PSZ.LEAGUE_PRESETS[leagueKey]) {
  const L = PSZ.LEAGUE_PRESETS[leagueKey];

  tempo = (tempo + L.tempo) / 2;
  volatility = (volatility + L.volatility) / 2;

  leagueRiskMod = L.riskMod;   // â¬…ï¸ SIMPAN DULU
  ctx.leaguePreset = leagueKey;
    }
    /* ============================
       AUTO RISK
       ============================ */
    let risk = volatility * 0.5
      + tempo / 10
      + (pressH + pressA) / 20;

    risk = PSZ.clamp(risk, 0, 1);
      
    /* ============================
       AUTO PARKIR BUS
       ============================ */
    const parkHome = (xgA - xgH > 0.7) || (imp > 7 && posH < 45);
    const parkAway = (xgH - xgA > 0.7) || (imp > 7 && posH > 55);

    /* ====l========================
       AUTO STAMINA BASELINE
       ============================ */
    const staminaH = PSZ.clamp(1 - (pressH - 5)*0.03 - (tempo - 5)*0.02, 0.6, 1);
    const staminaA = PSZ.clamp(1 - (pressA - 5)*0.03 - (tempo - 5)*0.02, 0.6, 1);

    /* ============================
       MATCH TYPE (AUTO OR MANUAL)
       ============================ */
    const mtSel = document.getElementById("match_type")?.value || "AUTO";
    const matchType = (mtSel === "AUTO")
      ? PSZ.autoDetectMatchType({ importance:imp, shots_home:shH, shots_away:shA })
      : mtSel;

    /* ============================
       FINAL CONTEXT
       ============================ */
    return {
  base:{
    xgH, xgA, shH, shA, sotH, sotA, posH,
    imp,
    impSource
  },
  auto:{
    pressH, pressA,
    ppdaH, ppdaA,
    tempo,
    volatility,
    risk,
    parkHome, parkAway,
    staminaH, staminaA,
    matchType
  }
};
  };

  

})(window.PSZ);
</script>
<script>
/* ======================================================
   PART 4 â€” CORE ENGINE
   Level 1500 â€” Dynamic Î», fxG, Stamina Decay
   ====================================================== */

window.PSZ = window.PSZ || {};
(function(PSZ){

  /* ============================
     Math helpers
     ============================ */
  PSZ.poissonPMF = function(lambda, k){
    if(lambda <= 0) return (k===0 ? 1 : 0);
    let p = Math.exp(-lambda);
    for(let i=1;i<=k;i++) p *= lambda / i;
    return p;
  };

  /* ============================
     Dynamic Lambda Builder
     ============================ */
  PSZ.buildDynamicLambda = function(ctx){
    const { xgH, xgA } = ctx.base;
    const A = ctx.auto;

    let lamH = xgH;
    let lamA = xgA;

    // tempo & volatility
    lamH *= (1 + (A.tempo - 5) * 0.06 + (A.volatility - 0.5) * 0.25);
    lamA *= (1 + (A.tempo - 5) * 0.06 + (A.volatility - 0.5) * 0.25);

    // pressing advantage
    lamH *= (1 + (A.pressH - A.pressA) * 0.04);
    lamA *= (1 + (A.pressA - A.pressH) * 0.04);

    // park the bus dampening
    // ðŸ”½ Dynamic park-the-bus dampening
let parkFactor = 0.88;
if(ctx.base.imp >= 8) parkFactor = 0.82;
if(ctx.base.imp >= 9) parkFactor = 0.78;

if(A.parkHome) lamH *= parkFactor;
if(A.parkAway) lamA *= parkFactor;

    lamH = PSZ.clamp(lamH, 0.2, 4.5);
    lamA = PSZ.clamp(lamA, 0.2, 4.5);

    return { lamH, lamA };
  };

  /* ============================
     fxG â€” Forced Error Goals
     ============================ */
  PSZ.computeFxG = function(ctx){
    const A = ctx.auto;

    const fatigueH = 1 - A.staminaH;
    const fatigueA = 1 - A.staminaA;

    const fxgH = PSZ.clamp(
      (A.pressH/10) * fatigueA * (0.5 + A.volatility),
      0, 0.6
    );

    const fxgA = PSZ.clamp(
      (A.pressA/10) * fatigueH * (0.5 + A.volatility),
      0, 0.6
    );

    return { fxgH, fxgA };
  };

  /* ============================
     Minute-by-minute stamina decay
     ============================ */
  PSZ.simulateStamina = function(stamina0, press, tempo){
    let stamina = stamina0;
    for(let m=1;m<=90;m++){
      let decay = 0.002;
      decay += (press - 5) * 0.0009;
      decay += (tempo - 5) * 0.0006;
      if(m >= 70) decay *= 1.8; // late spike
      stamina -= decay;
    }
    return PSZ.clamp(stamina, 0.3, 1);
  };

  /* ============================
     Apply stamina decay + fxG to lambda
     ============================ */
  PSZ.applyFatigueAndFxG = function(ctx, baseLam){
    const A = ctx.auto;

    const endStaminaH = PSZ.simulateStamina(A.staminaH, A.pressH, A.tempo);
    const endStaminaA = PSZ.simulateStamina(A.staminaA, A.pressA, A.tempo);

    const lateErrorBoostH = (1 - endStaminaA) * 0.35;
    const lateErrorBoostA = (1 - endStaminaH) * 0.35;

    const fxg = PSZ.computeFxG(ctx);

// ðŸ”½ FXG dampening for high-importance matches
let fxgFactor = 1;
if(ctx.base.imp >= 8) fxgFactor = 0.6;
if(ctx.base.imp >= 9) fxgFactor = 0.5;

let lamH = baseLam.lamH + (fxg.fxgH * fxgFactor) + lateErrorBoostH;
let lamA = baseLam.lamA + (fxg.fxgA * fxgFactor) + lateErrorBoostA;

    lamH = PSZ.clamp(lamH, 0.2, 5.2);
    lamA = PSZ.clamp(lamA, 0.2, 5.2);

    return {
      lamH, lamA,
      endStaminaH, endStaminaA,
      fxg
    };
  };

  

})(window.PSZ);
</script>
<script>
/* ======================================================
   PART 5 â€” MONTE CARLO ENGINE (NON-WORKER)
   Level 1500 â€” Score Matrix, H/D/A, BTTS
   ====================================================== */

window.PSZ = window.PSZ || {};
(function(PSZ){

  /* ============================
     Poisson sampler
     ============================ */
  PSZ.poissonSample = function(lambda){
    if(lambda <= 0) return 0;
    const L = Math.exp(-lambda);
    let k = 0, p = 1;
    do { k++; p *= Math.random(); } while(p > L);
    return k - 1;
  };

  /* ============================
     Monte Carlo Simulation
     ============================ */
  PSZ.runMonteCarlo = function(ctx, options){
    options = options || {};
    const N = options.N || 8000;   // aman untuk browser
    const CAP = options.cap || 6;

    // 1) Dynamic lambda + fatigue + fxG
    const baseLam = PSZ.buildDynamicLambda(ctx);
    const adjLam  = PSZ.applyFatigueAndFxG(ctx, baseLam);
    const lamH = adjLam.lamH;
    const lamA = adjLam.lamA;

    // 2) Init matrix
    const mat = {};
    for(let h=0; h<=CAP; h++){
      mat[h] = {};
      for(let a=0; a<=CAP; a++) mat[h][a] = 0;
    }

    // 3) Counters
    let homeWin=0, draw=0, awayWin=0;
    let btts=0, sumGoals=0;

    // 4) Run MC
    for(let i=0;i<N;i++){
      const gh = PSZ.poissonSample(lamH);
      const ga = PSZ.poissonSample(lamA);

      if(gh<=CAP && ga<=CAP) mat[gh][ga]++;

      if(gh > ga) homeWin++;
      else if(gh === ga) draw++;
      else awayWin++;

      if(gh>0 && ga>0) btts++;
      sumGoals += (gh + ga);
    }

    // 5) Normalize probs
    const pH = homeWin / N;
    const pD = draw / N;
    const pA = awayWin / N;
    const pBTTS = btts / N;
    const avgGoals = sumGoals / N;

    // 6) Top Correct Score
    const cs = [];
    for(let h=0; h<=CAP; h++){
      for(let a=0; a<=CAP; a++){
        const p = mat[h][a] / N;
        if(p>0) cs.push({score:`${h}-${a}`, p});
      }
    }
    cs.sort((x,y)=>y.p - x.p);
    const topCS = cs.slice(0,5);

    return {
      params:{
        lamH, lamA,
        endStaminaH: adjLam.endStaminaH,
        endStaminaA: adjLam.endStaminaA,
        fxg: adjLam.fxg
      },
      matrix: mat,
      probs:{ pH, pD, pA },
      BTTS: pBTTS,
      avgGoals,
      topCS,
      meta:{
        N, CAP,
        matchType: ctx.auto.matchType,
        tempo: ctx.auto.tempo,
        volatility: ctx.auto.volatility,
        risk: ctx.auto.risk
      }
    };
  };

  

})(window.PSZ);
</script>
<script>
/* ======================================================
   PART 6 â€” OUTPUT BUILDER & UI BINDING
   Level 1500 â€” FINAL RESULT DISPLAY
   ====================================================== */

window.PSZ = window.PSZ || {};
(function(PSZ){

  /* ============================
     Output Formatter
     ============================ */
  PSZ.buildOutputText = function(ctx, res){
    let t = "";
    t += "=== PSZ LEVEL 1500 â€” FULL POWER MODE ===\n\n";

    // Match Info
    t += "[MATCH INFO]\n";
    t += "Match Type   : " + ctx.auto.matchType + "\n";
    t += "Importance   : " + ctx.base.imp + "\n";
    t += "Tempo (Auto) : " + ctx.auto.tempo.toFixed(2) + "\n";
    t += "Volatility   : " + ctx.auto.volatility.toFixed(2) + "\n";
    t += "Risk Level   : " + ctx.auto.risk.toFixed(2) + "\n\n";

    // Lambda & fatigue
    t += "[ENGINE CORE]\n";
    t += "Î» Home       : " + res.params.lamH.toFixed(3) + "\n";
    t += "Î» Away       : " + res.params.lamA.toFixed(3) + "\n";
    t += "End Stamina H: " + res.params.endStaminaH.toFixed(2) + "\n";
    t += "End Stamina A: " + res.params.endStaminaA.toFixed(2) + "\n";
    t += "fxG Home     : " + res.params.fxg.fxgH.toFixed(3) + "\n";
    t += "fxG Away     : " + res.params.fxg.fxgA.toFixed(3) + "\n\n";

    // Probabilities
    t += "[PROBABILITIES]\n";
    t += "Home Win : " + (res.probs.pH*100).toFixed(1) + "%\n";
    t += "Draw     : " + (res.probs.pD*100).toFixed(1) + "%\n";
    t += "Away Win : " + (res.probs.pA*100).toFixed(1) + "%\n\n";

    // Goals
    t += "[GOALS]\n";
    t += "BTTS      : " + (res.BTTS*100).toFixed(1) + "%\n";
    t += "Avg Goals : " + res.avgGoals.toFixed(2) + "\n\n";

    // Correct Score
    t += "[TOP CORRECT SCORE]\n";
    res.topCS.forEach(cs=>{
      t += cs.score + " â†’ " + (cs.p*100).toFixed(2) + "%\n";
    });

    t += "\n[ENGINE NOTE]\n";
    t += "- All tactical inputs are AUTO generated\n";
    t += "- Pressing, PPDA, Tempo, Risk, Stamina = ENGINE\n";
    t += "- fxG & late error spike applied\n";

    return t;
  };

  /* ============================
     RUN BUTTON HANDLER
     ============================ */
  PSZ.runAnalysis = function(){
    const out = document.getElementById("output");
    if(!out) return;

    out.textContent = "Running analysis...\n";

    try{
      // 1) Build context
      const ctx = PSZ.buildAutoContext();

      // 2) Run Monte Carlo
      const res = PSZ.runMonteCarlo(ctx, { N: 8000, cap: 6 });

      // 3) Build output
      const text = PSZ.buildOutputText(ctx, res);
      out.textContent = text;

    }catch(e){
      out.textContent = "ERROR:\n" + (e.message || e);
      console.error(e);
    }
  };

  /* ============================
     Bind Button
     ============================ */
  document.addEventListener("DOMContentLoaded", function(){
    const btn = document.getElementById("runEngine");
    if(btn){
      btn.addEventListener("click", PSZ.runAnalysis);
    }
  });


})(window.PSZ);
</script>
<script>
/* ======================================================
   PART 7 â€” MATCH ARCHETYPE CLASSIFIER
   Level 1500 â€” Tactical Intelligence Layer
   ====================================================== */

window.PSZ = window.PSZ || {};
(function(PSZ){

  /* ============================
     Archetype Detection
     ============================ */
  PSZ.detectArchetype = function(ctx){
    const A = ctx.auto;
    const B = ctx.base;

    const pressDiff = Math.abs(A.pressH - A.pressA);
    const tempo = A.tempo;
    const vol = A.volatility;
    const posDiff = Math.abs(B.posH - 50);
    const shots = B.shH + B.shA;

    if(tempo >= 7.5 && vol >= 0.75 && shots >= 26)
      return "Chaos / Run & Gun";

    if(tempo <= 4 && vol <= 0.45 && shots <= 16)
      return "Slow Tactical / Low Event";

    if(A.pressH >= 7 && A.pressA >= 7)
      return "High Press Duel";

    if(posDiff >= 15 && shots <= 20)
      return "Possession vs Low Block";

    if(A.parkHome || A.parkAway)
      return "Defensive / Park The Bus";

    return "Balanced / Standard";
  };

  /* ============================
     Apply Archetype Modifiers
     ============================ */
  PSZ.applyArchetypeModifiers = function(ctx, lam){
    const arche = PSZ.detectArchetype(ctx);

    let lamH = lam.lamH;
    let lamA = lam.lamA;

    switch(arche){
      case "Chaos / Run & Gun":
        lamH *= 1.08;
        lamA *= 1.08;
        break;

      case "Slow Tactical / Low Event":
        lamH *= 0.92;
        lamA *= 0.92;
        break;

      case "High Press Duel":
        lamH *= 1.04;
        lamA *= 1.04;
        break;

      case "Possession vs Low Block":
        if(ctx.auto.parkAway) lamH *= 1.05;
        if(ctx.auto.parkHome) lamA *= 1.05;
        break;

      case "Defensive / Park The Bus":
        lamH *= 0.94;
        lamA *= 0.94;
        break;
    }

    return {
      lamH: PSZ.clamp(lamH, 0.2, 5.5),
      lamA: PSZ.clamp(lamA, 0.2, 5.5),
      archetype: arche
    };
  };

  /* ============================
     Hook archetype into engine
     ============================ */
  const _origBuildDynamicLambda = PSZ.buildDynamicLambda;
  PSZ.buildDynamicLambda = function(ctx){
    const baseLam = _origBuildDynamicLambda(ctx);
    const modLam  = PSZ.applyArchetypeModifiers(ctx, baseLam);
    ctx.auto.archetype = modLam.archetype;
    return { lamH: modLam.lamH, lamA: modLam.lamA };
  };

  /* ============================
     Extend Output (safe patch)
     ============================ */
  const _origBuildOutputText = PSZ.buildOutputText;
  PSZ.buildOutputText = function(ctx, res){
    let t = _origBuildOutputText(ctx, res);
    t += "\n[ARCHETYPE]\n";
    t += ctx.auto.archetype + "\n";
    t += "- Archetype modifies tempo & Î» adaptively\n";
    return t;
  };

  

})(window.PSZ);
</script>
    
<script>
/* ======================================================
   PART 8 â€” OU, CONFIDENCE & RECOMMENDATION
   Level 1500 â€” Final Enhancement
   ====================================================== */

window.PSZ = window.PSZ || {};
(function(PSZ){

  /* ============================
     Over / Under from MC Matrix
     ============================ */
  PSZ.computeOU = function(res){
    const lines = [0.5, 1.5, 2.5, 3.5];
    const out = {};
    const mat = res.matrix;
    const CAP = res.meta.CAP;
    const N = res.meta.N;

    lines.forEach(line=>{
      const cut = Math.floor(line);
      let under = 0;
      for(let h=0; h<=CAP; h++){
        for(let a=0; a<=CAP; a++){
          if(h + a <= cut) under += mat[h][a];
        }
      }
      out[line] = {
        under: under / N,
        over: 1 - (under / N)
      };
    });

    return out;
  };
// League preset bias (applied ONCE after MC OU)
    if (ctx.leaguePreset) {
  const L = PSZ.LEAGUE_PRESETS[ctx.leaguePreset];
  if (L) {
    ou[2.5].over = PSZ.clamp(ou[2.5].over + L.overBias, 0, 1);
    res.BTTS = PSZ.clamp(res.BTTS + L.bttsBias, 0, 1);
  }
    }
  /* ============================
     Confidence Score
     ============================ */
  PSZ.computeConfidence = function(ctx, res){
    const pMax = Math.max(res.probs.pH, res.probs.pD, res.probs.pA);
    let conf = pMax * 100;

    // penalty for chaos & high risk
    conf -= ctx.auto.volatility * 15;
    conf -= ctx.auto.risk * 10;

    // bonus for strong signal
    if(pMax >= 0.55) conf += 5;
    if(pMax >= 0.60) conf += 5;

    return PSZ.clamp(conf, 35, 95);
  };

  /* ============================
     Recommendation Builder
     ============================ */
  PSZ.buildRecommendation = function(ctx, res, ou, conf){
    let rec = {};

    // 1X2 lean
    if(res.probs.pH > res.probs.pD && res.probs.pH > res.probs.pA)
      rec.result = "LEAN HOME";
    else if(res.probs.pA > res.probs.pH && res.probs.pA > res.probs.pD)
      rec.result = "LEAN AWAY";
    else
      rec.result = "LEAN DRAW";

    // Goals lean (2.5 main)
    if(ou[2.5].over > 0.60 && ctx.auto.volatility < 0.75){
  rec.goals = "OVER 2.5";
}else{
  rec.goals = "UNDER 2.5";
          }
      // ðŸ”’ Block forced over in finals / ultra-high importance
if(ctx.base.imp >= 9 && ou[2.5].over < 0.62){
  rec.goals = "NO BET (GOALS)";
                          }
      // ðŸ” Under 2.5 confidence boost
let underBoost = 0;

// High importance â†’ cautious game
if(ctx.base.imp >= 8) underBoost += 6;

// Park-the-bus present
if(ctx.auto.parkHome || ctx.auto.parkAway) underBoost += 6;

// Low volatility match
if(ctx.auto.volatility < 0.55) underBoost += 5;

// Apply boost only if UNDER is selected
if(rec.goals === "UNDER 2.5"){
  conf = Math.min(100, conf + underBoost);
    }

    // BTTS lean (base)
rec.btts = res.BTTS > 0.55 ? "BTTS YES" : "BTTS NO";

// ðŸ”’ BTTS false-positive filters
// 1) Park the bus present
if(ctx.auto.parkHome || ctx.auto.parkAway){
  if(res.BTTS < 0.60) rec.btts = "BTTS NO";
}

// 2) High importance (final / semi)
if(ctx.base.imp >= 8 && res.BTTS < 0.62){
  rec.btts = "BTTS NO";
}

// 3) Low chaos late-game (stamina still high)
if(ctx.auto.volatility < 0.55 && res.BTTS < 0.60){
  rec.btts = "BTTS NO";
    }

    // Risk warning
    rec.warning = "NORMAL";
    if(ctx.auto.volatility >= 0.75 || ctx.auto.risk >= 0.75)
      rec.warning = "HIGH VARIANCE";
    if(conf < 45)
      rec.warning = "LOW CONFIDENCE";

    return rec;
  };
PSZ.buildReason = function(ctx, res, rec){

  let reasons = {
    goals: [],
    btts: [],
    result: []
  };

  /* ===== GOALS REASON ===== */
  if(rec.goals === "UNDER 2.5"){
    if(ctx.base.imp >= 8)
      reasons.goals.push("High match importance â†’ cautious play");

    if(ctx.auto.parkHome || ctx.auto.parkAway)
      reasons.goals.push("Park-the-bus detected");

    if(ctx.auto.volatility < 0.55)
      reasons.goals.push("Low volatility (controlled tempo)");

  }

  if(rec.goals === "OVER 2.5"){
    if(ctx.auto.volatility >= 0.65)
      reasons.goals.push("High volatility / open game");

    if(ctx.auto.tempo >= 6.5)
      reasons.goals.push("High tempo match");

    if(res.BTTS >= 0.60)
      reasons.goals.push("Both teams likely to score");
  }

  /* ===== BTTS REASON ===== */
  if(rec.btts === "BTTS YES"){
    if(res.BTTS >= 0.60)
      reasons.btts.push("Strong BTTS probability");

    if(ctx.auto.volatility >= 0.6)
      reasons.btts.push("Chaotic match profile");
  }

  if(rec.btts === "BTTS NO"){
    if(ctx.auto.parkHome || ctx.auto.parkAway)
      reasons.btts.push("One side likely defending deep");

    if(ctx.auto.volatility < 0.55)
      reasons.btts.push("Low late-game chaos");

    if(ctx.base.imp >= 8)
      reasons.btts.push("High-stakes match â†’ risk-averse play");
  }

  /* ===== RESULT (1X2) REASON ===== */
  if(rec.result === "LEAN HOME"){
    reasons.result.push("Home expected goals advantage");
  }

  if(rec.result === "LEAN AWAY"){
    reasons.result.push("Away expected goals advantage");
  }

  if(rec.result === "LEAN DRAW"){
    reasons.result.push("Balanced expected goals & tempo");
  }

  return reasons;
};
    /* ======================================
   FINAL NO BET GATE â€” v1700 SAFE
   ====================================== */
PSZ.applyFinalNoBetGate = function(ctx, rec, conf){
  let reasons = [];

  // Rule 1: confidence zone
  if(conf < 60){
    reasons.push("Low confidence (<60)");
  }

  // Rule 2: big match no edge
  if(ctx.base?.imp >= 8 && conf < 65){
    reasons.push("High importance without strong edge");
  }

  // Rule 3: volatility extremes
  if(ctx.auto?.volatility < 0.40){
  reasons.push("Very low volatility (deadlock risk)");
}
if(ctx.auto?.volatility > 0.80){
  reasons.push("Very high volatility (chaos risk)");
    }

  // Rule 4: conflicting signals
  let conflict = 0;
  if(ctx.auto?.tempo < 4) conflict++;
  if(ctx.auto?.volatility < 0.45) conflict++;
  if(ctx.base?.imp >= 8) conflict++;

  if(conflict >= 2){
    reasons.push("Multiple conflicting signals");
  }

  // === FORCE NO BET ===
  if(reasons.length){
    return {
      result: "NO BET",
      goals: "NO BET",
      btts: "NO BET",
      noBetReasons: reasons
    };
  }
let minConf = 60;

if (ctx.leaguePreset && PSZ.LEAGUE_PRESETS[ctx.leaguePreset]?.confMin) {
  minConf = PSZ.LEAGUE_PRESETS[ctx.leaguePreset].confMin;
}

if (conf < minConf) {
  reasons.push(`Low confidence (<${minConf})`);
    }
    if (
  ctx.leaguePreset &&
  PSZ.LEAGUE_PRESETS[ctx.leaguePreset]?.noBetStrict &&
  conf < 70
) {
  reasons.push("Strict league: confidence too low");
    }
  return rec;
};
  /* ============================
     Patch Output Builder
     ============================ */
  const _origBuildOutputText = PSZ.buildOutputText;
  PSZ.buildOutputText = function(ctx, res){

    const baseText = _origBuildOutputText(ctx, res);

    const ou = PSZ.computeOU(res);
    const conf = PSZ.computeConfidence(ctx, res);
    let rec = PSZ.buildRecommendation(ctx, res, ou, conf);
    rec = PSZ.applyFinalNoBetGate(ctx, rec, conf);
    const reasons = PSZ.buildReason(ctx, res, rec); 
    
    
      
    let t = baseText;

    // Over / Under
    t += "\n[OVER / UNDER]\n";
    Object.keys(ou).forEach(k=>{
      t += "O/U " + k +
           " â†’ Over " + (ou[k].over*100).toFixed(1) + "%" +
           " | Under " + (ou[k].under*100).toFixed(1) + "%\n";
    });

    // Recommendation
    t += "\n[RECOMMENDATION]\n";
    t += "Result : " + rec.result + "\n";
    t += "Goals  : " + rec.goals + "\n";
    t += "BTTS   : " + rec.btts + "\n";
if(ctx.leaguePreset){
  t += "\n[LEAGUE PRESET]\n";
  t += ctx.leaguePreset + "\n";
    }
    // ===== REASONS =====
if(reasons.goals.length){
  t += "\nReason (Goals):\n";
  reasons.goals.forEach(r => {
    t += "- " + r + "\n";
  });
}

if(reasons.btts.length){
  t += "\nReason (BTTS):\n";
  reasons.btts.forEach(r => {
    t += "- " + r + "\n";
  });
}

if(reasons.result.length){
  t += "\nReason (Result):\n";
  reasons.result.forEach(r => {
    t += "- " + r + "\n";
  });
    }
    t += "Note   : " + rec.warning + "\n";

    // Confidence
    t += "\n[CONFIDENCE SCORE]\n";
    t += conf.toFixed(0) + " / 100\n";

    return t;
  };
                                                   

  

})(window.PSZ);
</script>
    <script>
/* ======================================================
   PART 9 â€” ASIAN HANDICAP ENGINE
   Level 1500 â€” Market Accurate
   ====================================================== */

window.PSZ = window.PSZ || {};
(function(PSZ){

  /* ============================
     Asian Handicap Calculator
     ============================ */
  PSZ.computeAH = function(res){
    const mat = res.matrix;
    const CAP = res.meta.CAP;
    const N   = res.meta.N;

    const lines = [-1.25, -1, -0.75, -0.5, -0.25, 0,
                    0.25, 0.5, 0.75, 1, 1.25];

    function probForLine(line){
      let win=0, halfWin=0, push=0, halfLose=0, lose=0;

      for(let h=0; h<=CAP; h++){
        for(let a=0; a<=CAP; a++){
          const p = mat[h][a] / N;
          const diff = h - a + line;

          if(diff > 0.5) win += p;
          else if(diff === 0.5) halfWin += p;
          else if(diff === 0) push += p;
          else if(diff === -0.5) halfLose += p;
          else lose += p;
        }
      }

      return { win, halfWin, push, halfLose, lose };
    }

    const out = {};
    lines.forEach(l=>{
      out[l] = probForLine(l);
    });

    return out;
  };

  /* ============================
     Patch Output
     ============================ */
  const _origBuildOutputText = PSZ.buildOutputText;
  PSZ.buildOutputText = function(ctx, res){

    const baseText = _origBuildOutputText(ctx, res);
    const ah = PSZ.computeAH(res);

    let t = baseText;
    t += "\n[ASIAN HANDICAP]\n";

    Object.keys(ah).forEach(k=>{
      const x = ah[k];
      const cover =
        x.win + x.halfWin +
        0.5 * x.push;

      t += "AH " + k +
           " â†’ Cover " + (cover*100).toFixed(1) +
           "% | Lose " + ((1-cover)*100).toFixed(1) + "%\n";
    });

    return t;
  };

  

})(window.PSZ);
    </script>
    
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PSZ Engine — Clean Rebuild</title>

<style>
body{
  margin:0;
  font-family:Arial,Helvetica,sans-serif;
  background:#0d1117;
  color:#e6edf3;
  display:flex;
  height:100vh;
}
#left{
  width:30%;
  background:#161b22;
  padding:16px;
  overflow-y:auto;
  border-right:2px solid #30363d;
}
#right{
  flex:1;
  padding:16px;
  overflow-y:auto;
}
.section{
  margin-bottom:16px;
}
.section h3{
  margin:12px 0 6px;
  border-bottom:1px solid #30363d;
  padding-bottom:4px;
}
label{
  font-size:13px;
}
input,select,button{
  width:100%;
  margin:4px 0 10px;
  padding:6px;
  border-radius:6px;
  border:none;
  background:#21262d;
  color:#e6edf3;
}
button{
  background:#238636;
  font-weight:bold;
  cursor:pointer;
}
button:hover{
  background:#2ea043;
}
#output{
  white-space:pre-wrap;
  background:#0d1117;
  border:1px solid #30363d;
  padding:12px;
  border-radius:6px;
  min-height:300px;
}
</style>
</head>

<body>

<div id="left">

  <div class="section">
    <h3>Match Data</h3>

    <label>xG Home</label>
    <input id="xgH" type="number" step="0.01">

    <label>xG Away</label>
    <input id="xgA" type="number" step="0.01">

    <label>Shots Home</label>
    <input id="shH" type="number">

    <label>Shots Away</label>
    <input id="shA" type="number">

    <label>SOT Home</label>
    <input id="sotH" type="number">

    <label>SOT Away</label>
    <input id="sotA" type="number">

    <label>Possession Home (%)</label>
    <input id="posH" type="number">

    <label>Importance (1–10)</label>
    <input id="imp" type="number" min="1" max="10">
  </div>

  <div class="section">
    <h3>Match Type</h3>
    <select id="matchType"></select>
  </div>

  <div class="section">
    <h3>Context Preset</h3>

    <label>League</label>
    <select id="league">
      <option value="AUTO">AUTO</option>
      <option value="EPL">EPL</option>
      <option value="BUNDES">Bundesliga</option>
      <option value="SERIEA">Serie A</option>
      <option value="LALIGA">LaLiga</option>
      <option value="UCL">UCL</option>
      <option value="CUP">Cup</option>
    </select>

    <label>Home Tier</label>
    <select id="homeTier">
      <option value="AUTO">AUTO</option>
      <option value="BIG">BIG</option>
      <option value="MID">MID</option>
      <option value="SMALL">SMALL</option>
    </select>

    <label>Away Tier</label>
    <select id="awayTier">
      <option value="AUTO">AUTO</option>
      <option value="BIG">BIG</option>
      <option value="MID">MID</option>
      <option value="SMALL">SMALL</option>
    </select>
  </div>

  <button id="runBtn">RUN ANALYSIS</button>

</div>

<div id="right">
  <h3>Output</h3>
  <div id="output">Waiting for input…</div>
</div>
<script>
/* ======================================================
   PART 2 — MATCH TYPE REGISTRY & CONTEXT FLAG
   CLEAN REBUILD (NO ENGINE)
   ====================================================== */

window.PSZ = window.PSZ || {};
(function(PSZ){

  /* ============================
     MATCH TYPE LIST (EXTENSIBLE)
     ============================ */
  PSZ.MATCH_TYPES = [
    // League
    { id:"league_standard", label:"League — Standard" },
    { id:"league_big_match", label:"League — Big Match" },
    { id:"league_title", label:"League — Title Decider" },
    { id:"league_relegation", label:"League — Relegation Fight" },
    { id:"league_low", label:"League — Low Stakes" },

    // Domestic Cup
    { id:"cup_early", label:"Cup — Early Round" },
    { id:"cup_quarter", label:"Cup — Quarter Final" },
    { id:"cup_semi", label:"Cup — Semi Final" },
    { id:"cup_final", label:"Cup — Final" },
    { id:"cup_1st_leg", label:"Cup — First Leg" },
    { id:"cup_2nd_leg", label:"Cup — Second Leg" },

    // Continental
    { id:"ucl_group", label:"UCL — Group Stage" },
    { id:"ucl_knockout", label:"UCL — Knockout" },
    { id:"ucl_quarter", label:"UCL — Quarter Final" },
    { id:"ucl_semi", label:"UCL — Semi Final" },
    { id:"ucl_final", label:"UCL — Final" },

    // Special
    { id:"friendly", label:"Friendly Match" },
    { id:"derby", label:"Derby / Rivalry" }
  ];

  /* ============================
     Populate Match Type Dropdown
     ============================ */
  PSZ.initMatchTypeUI = function(){
    const sel = document.getElementById("match_type");
    if(!sel) return;

    sel.innerHTML = "";
    const optAuto = document.createElement("option");
    optAuto.value = "AUTO";
    optAuto.textContent = "AUTO (Engine Detect)";
    sel.appendChild(optAuto);

    PSZ.MATCH_TYPES.forEach(mt=>{
      const o = document.createElement("option");
      o.value = mt.id;
      o.textContent = mt.label;
      sel.appendChild(o);
    });
  };

  /* ============================
     Auto Match Type Detection
     (simple & safe)
     ============================ */
  PSZ.autoDetectMatchType = function(ctx){
    const imp = ctx.importance || 5;

    if(imp >= 9) return "league_title";
    if(imp >= 8) return "ucl_knockout";
    if(imp <= 3) return "league_low";

    return "league_standard";
  };

  /* ============================
     Init on DOM ready
     ============================ */
  document.addEventListener("DOMContentLoaded", function(){
    PSZ.initMatchTypeUI();
  });

  console.log("PART 2 loaded: Match Type Registry");

})(window.PSZ);
</script>
  <script>
/* ======================================================
   PART 3 — AUTO CONTEXT ENGINE
   Stable Core (NO PRESET, NO MC)
   ====================================================== */

window.PSZ = window.PSZ || {};
(function(PSZ){

  /* ---------- Helpers ---------- */
  PSZ.num = (v, d=0)=> {
    v = parseFloat(v);
    return isFinite(v) ? v : d;
  };
  PSZ.clamp = (v, a, b)=> Math.max(a, Math.min(b, v));

  /* ======================================================
     BUILD AUTO CONTEXT
     ====================================================== */
  PSZ.buildAutoContext = function(){

    /* ---------- RAW INPUT ---------- */
    const xgH  = PSZ.num(document.getElementById("xg_home")?.value, 1.2);
    const xgA  = PSZ.num(document.getElementById("xg_away")?.value, 1.0);
    const shH  = PSZ.num(document.getElementById("shots_home")?.value, 12);
    const shA  = PSZ.num(document.getElementById("shots_away")?.value, 10);
    const sotH = PSZ.num(document.getElementById("sot_home")?.value, 4);
    const sotA = PSZ.num(document.getElementById("sot_away")?.value, 3);
    const posH = PSZ.num(document.getElementById("pos_home")?.value, 50);
    const imp  = PSZ.num(document.getElementById("importance")?.value, 5);

    /* ---------- PRESSING (AUTO) ---------- */
    let pressH = 5
      + (shA - shH) * 0.12
      + (50 - posH) * 0.06
      + (sotA - sotH) * 0.18;

    let pressA = 5
      + (shH - shA) * 0.12
      + (posH - 50) * 0.06
      + (sotH - sotA) * 0.18;

    pressH = PSZ.clamp(pressH, 1, 9);
    pressA = PSZ.clamp(pressA, 1, 9);

    /* ---------- PPDA (DERIVED FROM PRESSING) ---------- */
    let ppdaH = 14 - pressH * 0.9 + (posH - 50) * 0.05;
    let ppdaA = 14 - pressA * 0.9 + (50 - posH) * 0.05;

    ppdaH = PSZ.clamp(ppdaH, 5, 25);
    ppdaA = PSZ.clamp(ppdaA, 5, 25);

    const avgPPDA = (ppdaH + ppdaA) / 2;

    /* ---------- TEMPO (AUTO) ---------- */
    let tempo = 5
      + (shH + shA) / 20
      + (pressH + pressA - 10) * 0.15
      + (12 - avgPPDA) * 0.08
      - (imp - 5) * 0.25;

    tempo = PSZ.clamp(tempo, 1, 9);

    /* ---------- VOLATILITY / CHAOS ---------- */
    let volatility = 0.5
      + (tempo - 5) * 0.12
      + Math.abs(pressH - pressA) * 0.10
      + Math.abs(posH - 50) / 50 * 0.4;

    volatility = PSZ.clamp(volatility, 0.3, 1);

    /* ---------- RISK ---------- */
    let risk = volatility * 0.5
      + tempo / 10
      + (pressH + pressA) / 20;

    risk = PSZ.clamp(risk, 0, 1);

    /* ---------- PARK THE BUS DETECTION ---------- */
    const parkHome =
      (xgA - xgH > 0.7) ||
      (imp >= 7 && posH < 45);

    const parkAway =
      (xgH - xgA > 0.7) ||
      (imp >= 7 && posH > 55);

    /* ---------- STAMINA BASELINE ---------- */
    const staminaH = PSZ.clamp(
      1 - (pressH - 5) * 0.03 - (tempo - 5) * 0.02,
      0.6, 1
    );

    const staminaA = PSZ.clamp(
      1 - (pressA - 5) * 0.03 - (tempo - 5) * 0.02,
      0.6, 1
    );

    /* ---------- MATCH TYPE ---------- */
    const mtSel = document.getElementById("match_type")?.value || "AUTO";
    const matchType = (mtSel === "AUTO")
      ? PSZ.autoDetectMatchType({
          importance: imp,
          shots_home: shH,
          shots_away: shA
        })
      : mtSel;

    /* ---------- FINAL CONTEXT ---------- */
    return {
      base:{
        xgH, xgA,
        shH, shA,
        sotH, sotA,
        posH, imp
      },
      auto:{
        pressH, pressA,
        ppdaH, ppdaA,
        tempo,
        volatility,
        risk,
        parkHome, parkAway,
        staminaH, staminaA,
        matchType
      }
    };
  };

  console.log("PART 3 loaded — Auto Context Engine (STABLE)");

})(window.PSZ);
  </script>
  <script>
/* ======================================================
   PART 4 — CORE ENGINE
   Build Match Parameters (λ, tempo, pressure impact)
   ====================================================== */

window.PSZ = window.PSZ || {};
(function(PSZ){

  /* ============================
     Clamp helper (safety)
     ============================ */
  PSZ.clamp = PSZ.clamp || function(v, min, max){
    return Math.max(min, Math.min(max, v));
  };

  /* ============================
     Build Base Lambda (from xG)
     ============================ */
  PSZ.buildBaseLambda = function(ctx){
    let lamH = ctx.base.xgH;
    let lamA = ctx.base.xgA;

    lamH = PSZ.clamp(lamH, 0.2, 4.0);
    lamA = PSZ.clamp(lamA, 0.2, 4.0);

    return { lamH, lamA };
  };

  /* ============================
     Apply Tempo & Volatility
     ============================ */
  PSZ.applyTempoVolatility = function(ctx, lam){
    const A = ctx.auto;

    let lamH = lam.lamH;
    let lamA = lam.lamA;

    // tempo impact
    lamH *= (1 + (A.tempo - 5) * 0.06);
    lamA *= (1 + (A.tempo - 5) * 0.06);

    // volatility impact
    lamH *= (1 + (A.volatility - 0.5) * 0.25);
    lamA *= (1 + (A.volatility - 0.5) * 0.25);

    return {
      lamH: PSZ.clamp(lamH, 0.2, 5.0),
      lamA: PSZ.clamp(lamA, 0.2, 5.0)
    };
  };

  /* ============================
     Apply Pressing & PPDA
     ============================ */
  PSZ.applyPressingEffect = function(ctx, lam){
    const A = ctx.auto;

    let lamH = lam.lamH;
    let lamA = lam.lamA;

    // pressing advantage
    lamH *= (1 + (A.pressH - A.pressA) * 0.04);
    lamA *= (1 + (A.pressA - A.pressH) * 0.04);

    // PPDA dampening (high PPDA = low intensity)
    lamH *= (1 + (14 - A.ppdaA) * 0.015);
    lamA *= (1 + (14 - A.ppdaH) * 0.015);

    return {
      lamH: PSZ.clamp(lamH, 0.2, 5.2),
      lamA: PSZ.clamp(lamA, 0.2, 5.2)
    };
  };

  /* ============================
     Park The Bus Modifier
     ============================ */
  PSZ.applyDefensiveBias = function(ctx, lam){
    let lamH = lam.lamH;
    let lamA = lam.lamA;

    if(ctx.auto.parkHome) lamH *= 0.88;
    if(ctx.auto.parkAway) lamA *= 0.88;

    return {
      lamH: PSZ.clamp(lamH, 0.2, 4.8),
      lamA: PSZ.clamp(lamA, 0.2, 4.8)
    };
  };

  /* ============================
     FINAL LAMBDA PIPELINE
     ============================ */
  PSZ.buildFinalLambda = function(ctx){
    let lam = PSZ.buildBaseLambda(ctx);
    lam = PSZ.applyTempoVolatility(ctx, lam);
    lam = PSZ.applyPressingEffect(ctx, lam);
    lam = PSZ.applyDefensiveBias(ctx, lam);

    return lam;
  };

  console.log("PART 4 loaded: Core Engine (Lambda Builder)");

})(window.PSZ);
  </script>
  <script>
/* ======================================================
   PART 5 — MONTE CARLO ENGINE
   Stable Core Simulation (Browser Safe)
   ====================================================== */

window.PSZ = window.PSZ || {};
(function(PSZ){

  /* ============================
     Poisson Random Sampler
     ============================ */
  PSZ.poissonSample = function(lambda){
    if(lambda <= 0) return 0;
    const L = Math.exp(-lambda);
    let k = 0;
    let p = 1;
    do {
      k++;
      p *= Math.random();
    } while (p > L);
    return k - 1;
  };

  /* ============================
     Monte Carlo Simulation
     ============================ */
  PSZ.runMonteCarlo = function(ctx, opt){
    opt = opt || {};
    const N   = opt.N   || 8000;   // aman utk browser
    const CAP = opt.cap || 6;

    /* --- Build λ --- */
    const baseLam = PSZ.buildDynamicLambda(ctx);
    const adjLam  = PSZ.applyFatigueAndFxG(ctx, baseLam);

    const lamH = adjLam.lamH;
    const lamA = adjLam.lamA;

    /* --- Init matrix --- */
    const matrix = {};
    for(let h=0; h<=CAP; h++){
      matrix[h] = {};
      for(let a=0; a<=CAP; a++) matrix[h][a] = 0;
    }

    /* --- Counters --- */
    let homeWin = 0;
    let draw    = 0;
    let awayWin = 0;
    let btts    = 0;
    let sumG    = 0;

    /* --- Simulation loop --- */
    for(let i=0; i<N; i++){
      const gh = PSZ.poissonSample(lamH);
      const ga = PSZ.poissonSample(lamA);

      if(gh <= CAP && ga <= CAP){
        matrix[gh][ga]++;
      }

      if(gh > ga) homeWin++;
      else if(gh === ga) draw++;
      else awayWin++;

      if(gh > 0 && ga > 0) btts++;
      sumG += (gh + ga);
    }

    /* --- Probabilities --- */
    const pH = homeWin / N;
    const pD = draw / N;
    const pA = awayWin / N;

    /* --- Avg goals --- */
    const avgGoals = sumG / N;

    /* --- Top Correct Scores --- */
    const scores = [];
    for(let h=0; h<=CAP; h++){
      for(let a=0; a<=CAP; a++){
        const p = matrix[h][a] / N;
        if(p > 0){
          scores.push({ score: `${h}-${a}`, p });
        }
      }
    }
    scores.sort((x,y)=>y.p - x.p);

    return {
      params: {
        lamH,
        lamA,
        endStaminaH: adjLam.endStaminaH,
        endStaminaA: adjLam.endStaminaA,
        fxg: adjLam.fxg
      },
      matrix,
      probs: {
        pH, pD, pA
      },
      BTTS: btts / N,
      avgGoals,
      topCS: scores.slice(0,5),
      meta: {
        N,
        CAP,
        tempo: ctx.auto.tempo,
        volatility: ctx.auto.volatility,
        risk: ctx.auto.risk,
        matchType: ctx.auto.matchType
      }
    };
  };


  console.log("PART 5 loaded: Monte Carlo Engine (STABLE)");

})(window.PSZ);
  </script>
  <script>
/* ======================================================
   PART 6 — RUN ENGINE & FINAL OUTPUT
   Clean Version — NO DUPLICATION
   ====================================================== */

window.PSZ = window.PSZ || {};
(function(PSZ){

  /* ============================
     FINAL OUTPUT BUILDER
     ============================ */
  PSZ.buildOutputText = function(ctx, res){
    let t = "";
    t += "=== PSZ PREDICTION ENGINE ===\n\n";

    /* ---- CONTEXT ---- */
    t += "[MATCH CONTEXT]\n";
    t += "Match Type : " + ctx.auto.matchType + "\n";
    t += "League     : " + ctx.auto.leaguePreset + "\n";
    t += "Home Tier  : " + ctx.auto.homeTier + "\n";
    t += "Away Tier  : " + ctx.auto.awayTier + "\n\n";

    /* ---- ENGINE CORE ---- */
    t += "[ENGINE CORE]\n";
    t += "Tempo      : " + ctx.auto.tempo.toFixed(2) + "\n";
    t += "Press H/A  : " + ctx.auto.pressH.toFixed(2) + " / " + ctx.auto.pressA.toFixed(2) + "\n";
    t += "PPDA H/A   : " + ctx.auto.ppdaH.toFixed(2) + " / " + ctx.auto.ppdaA.toFixed(2) + "\n";
    t += "Volatility : " + ctx.auto.volatility.toFixed(2) + "\n";
    t += "Risk       : " + ctx.auto.risk.toFixed(2) + "\n\n";

    /* ---- LAMBDA ---- */
    t += "[GOAL MODEL]\n";
    t += "λ Home : " + res.params.lamH.toFixed(3) + "\n";
    t += "λ Away : " + res.params.lamA.toFixed(3) + "\n";
    t += "fxG H/A: " + res.params.fxg.fxgH.toFixed(3) + " / " + res.params.fxg.fxgA.toFixed(3) + "\n\n";

    /* ---- PROBABILITIES ---- */
    t += "[PROBABILITIES]\n";
    t += "Home Win : " + (res.probs.pH*100).toFixed(1) + "%\n";
    t += "Draw     : " + (res.probs.pD*100).toFixed(1) + "%\n";
    t += "Away Win : " + (res.probs.pA*100).toFixed(1) + "%\n\n";

    /* ---- GOALS ---- */
    t += "[GOALS]\n";
    t += "BTTS      : " + (res.BTTS*100).toFixed(1) + "%\n";
    t += "Avg Goals : " + res.avgGoals.toFixed(2) + "\n\n";

    /* ---- TOP SCORES ---- */
    t += "[TOP CORRECT SCORES]\n";
    res.topCS.forEach(s=>{
      t += s.score + " → " + (s.p*100).toFixed(2) + "%\n";
    });

    t += "\n[ENGINE NOTE]\n";
    t += "- Tempo, Pressing, PPDA = AUTO\n";
    t += "- League & Tier preset applied\n";
    t += "- Monte Carlo Simulation\n";

    return t;
  };

  /* ============================
     RUN ANALYSIS (BUTTON)
     ============================ */
  PSZ.runAnalysis = function(){
    try{
      /* --- Build Context --- */
      const ctx = PSZ.buildAutoContext();

      /* --- League Preset --- */
      const leagueSel = document.getElementById("league_preset")?.value || "AUTO";
      let leagueKey = leagueSel;

      if(leagueSel === "AUTO"){
        leagueKey =
          ctx.auto.matchType.includes("ucl") ? "UCL" :
          ctx.auto.matchType.includes("cup") ? "CUP" :
          "EPL";
      }

      /* --- Team Tier --- */
      const homeTierSel = document.getElementById("home_tier")?.value || "AUTO";
      const awayTierSel = document.getElementById("away_tier")?.value || "AUTO";

      const homeTier = homeTierSel === "AUTO"
        ? PSZ.autoTeamTier(ctx.base.xgH, ctx.base.shH)
        : homeTierSel;

      const awayTier = awayTierSel === "AUTO"
        ? PSZ.autoTeamTier(ctx.base.xgA, ctx.base.shA)
        : awayTierSel;

      /* --- Apply Preset --- */
      PSZ.applyContextPresets(ctx, leagueKey, homeTier, awayTier);

      ctx.auto.leaguePreset = leagueKey;
      ctx.auto.homeTier = homeTier;
      ctx.auto.awayTier = awayTier;

      /* --- Run Simulation --- */
      const res = PSZ.runMonteCarlo(ctx);

      /* --- Output --- */
      const outEl = document.getElementById("output");
      outEl.textContent = PSZ.buildOutputText(ctx, res);

    }catch(err){
      console.error(err);
      document.getElementById("output").textContent =
        "ENGINE ERROR:\n" + err.message;
    }
  };

  /* ============================
     BIND BUTTON
     ============================ */
  document.addEventListener("DOMContentLoaded", ()=>{
    const btn = document.getElementById("runEngine");
    if(btn){
      btn.addEventListener("click", PSZ.runAnalysis);
    }
  });

  console.log("PART 6 loaded: Run Engine & Output (CLEAN)");

})(window.PSZ);
  </script>
  <script>
/* ======================================================
   PART 7 — MATCH DYNAMICS & GAME STATE
   Non-League Intelligence Layer
   ====================================================== */

window.PSZ = window.PSZ || {};
(function(PSZ){

  /* ============================
     Game State Estimation
     ============================ */
  PSZ.detectGameState = function(ctx){
    const xgDiff = ctx.base.xgH - ctx.base.xgA;
    const imp = ctx.base.imp;

    if(xgDiff >= 0.6) return "HOME_LEADING";
    if(xgDiff <= -0.6) return "AWAY_LEADING";

    if(imp >= 7) return "TENSE_NEUTRAL";
    return "BALANCED";
  };

  /* ============================
     Apply Game State Modifiers
     ============================ */
  PSZ.applyGameStateEffects = function(ctx, lam){
    const state = PSZ.detectGameState(ctx);

    let lamH = lam.lamH;
    let lamA = lam.lamA;

    switch(state){
      case "HOME_LEADING":
        lamH *= 0.95;   // protect lead
        lamA *= 1.06;   // chase mode
        break;

      case "AWAY_LEADING":
        lamA *= 0.95;
        lamH *= 1.06;
        break;

      case "TENSE_NEUTRAL":
        lamH *= 0.98;
        lamA *= 0.98;   // draw gravity
        break;

      case "BALANCED":
      default:
        // no change
        break;
    }

    return {
      lamH: PSZ.clamp(lamH, 0.2, 5.8),
      lamA: PSZ.clamp(lamA, 0.2, 5.8),
      gameState: state
    };
  };

  /* ============================
     Hook into Dynamic Lambda
     ============================ */
  const _origBuildDynamicLambda = PSZ.buildDynamicLambda;
  PSZ.buildDynamicLambda = function(ctx){
    const baseLam = _origBuildDynamicLambda(ctx);
    const mod = PSZ.applyGameStateEffects(ctx, baseLam);
    ctx.auto.gameState = mod.gameState;
    return { lamH: mod.lamH, lamA: mod.lamA };
  };

  /* ============================
     Extend Output (SAFE PATCH)
     ============================ */
  const _origBuildOutputText = PSZ.buildOutputText;
  PSZ.buildOutputText = function(ctx, res){
    let t = _origBuildOutputText(ctx, res);
    t += "\n[GAME STATE]\n";
    t += ctx.auto.gameState + "\n";
    t += "- Engine adjusts aggression & draw bias automatically\n";
    return t;
  };

  console.log("PART 7 loaded: Match Dynamics & Game State");

})(window.PSZ);
  </script>
  <script>
/* ======================================================
   PART 8 — OU, CONFIDENCE & RECOMMENDATION
   FINAL ENHANCEMENT LAYER
   ====================================================== */

window.PSZ = window.PSZ || {};
(function(PSZ){

  /* ============================
     Over / Under Calculation
     ============================ */
  PSZ.computeOU = function(res){
    const lines = [0.5, 1.5, 2.5, 3.5];
    const out = {};
    const mat = res.matrix;
    const CAP = res.meta.CAP;
    const N = res.meta.N;

    lines.forEach(line=>{
      const cut = Math.floor(line);
      let under = 0;
      for(let h=0; h<=CAP; h++){
        for(let a=0; a<=CAP; a++){
          if(h + a <= cut) under += mat[h][a];
        }
      }
      out[line] = {
        under: under / N,
        over: 1 - (under / N)
      };
    });
    return out;
  };

  /* ============================
     Confidence Score
     ============================ */
  PSZ.computeConfidence = function(ctx, res){
    const pMax = Math.max(res.probs.pH, res.probs.pD, res.probs.pA);
    let conf = pMax * 100;

    conf -= ctx.auto.volatility * 15;
    conf -= ctx.auto.risk * 10;

    if(pMax >= 0.55) conf += 5;
    if(pMax >= 0.60) conf += 5;

    return PSZ.clamp(conf, 35, 95);
  };

  /* ============================
     Recommendation Builder
     ============================ */
  PSZ.buildRecommendation = function(ctx, res, ou, conf){
    const rec = {};

    // Result
    if(res.probs.pH > res.probs.pD && res.probs.pH > res.probs.pA)
      rec.result = "LEAN HOME";
    else if(res.probs.pA > res.probs.pH && res.probs.pA > res.probs.pD)
      rec.result = "LEAN AWAY";
    else
      rec.result = "LEAN DRAW";

    // Goals
    rec.goals = ou[2.5].over > 0.55 ? "OVER 2.5" : "UNDER 2.5";

    // BTTS
    rec.btts = res.BTTS > 0.55 ? "BTTS YES" : "BTTS NO";

    // Warning
    rec.warning = "NORMAL";
    if(ctx.auto.volatility >= 0.75 || ctx.auto.risk >= 0.75)
      rec.warning = "HIGH VARIANCE";
    if(conf < 45)
      rec.warning = "LOW CONFIDENCE";

    return rec;
  };

  /* ============================
     SAFE OUTPUT EXTENSION
     ============================ */
  const _origBuildOutputText = PSZ.buildOutputText;
  PSZ.buildOutputText = function(ctx, res){

    // Ambil output lama (PART 6 & 7)
    let t = _origBuildOutputText(ctx, res);

    // Hitung tambahan
    const ou = PSZ.computeOU(res);
    const conf = PSZ.computeConfidence(ctx, res);
    const rec = PSZ.buildRecommendation(ctx, res, ou, conf);

    t += "\n[OVER / UNDER]\n";
    Object.keys(ou).forEach(k=>{
      t += "O/U " + k +
           " → Over " + (ou[k].over*100).toFixed(1) +
           "% | Under " + (ou[k].under*100).toFixed(1) + "%\n";
    });

    t += "\n[CONFIDENCE]\n";
    t += conf.toFixed(1) + "%\n";

    t += "\n[RECOMMENDATION]\n";
    t += "Result : " + rec.result + "\n";
    t += "Goals  : " + rec.goals + "\n";
    t += "BTTS   : " + rec.btts + "\n";
    t += "Risk   : " + rec.warning + "\n";

    return t;
  };

  console.log("PART 8 loaded: OU + Confidence + Recommendation");

})(window.PSZ);
  </script>
</body>
  </html>

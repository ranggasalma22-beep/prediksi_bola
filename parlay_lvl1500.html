<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PSZ LEVEL 1500 - FULL POWER MODE</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #0d1117;
        color: #e6edf3;
        margin: 0;
        padding: 0;
        display: flex;
        height: 100vh;
        overflow: hidden;
    }
    #leftPanel {
        width: 28%;
        background: #161b22;
        padding: 20px;
        overflow-y: auto;
        border-right: 2px solid #30363d;
    }
    #rightPanel {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 20px;
        overflow-y: auto;
    }
    .sectionTitle {
        font-size: 18px;
        margin: 20px 0 10px;
        font-weight: bold;
        border-bottom: 1px solid #30363d;
        padding-bottom: 5px;
    }
    select, input {
        width: 100%;
        padding: 6px;
        margin: 6px 0;
        border-radius: 6px;
        border: none;
        background: #21262d;
        color: #e6edf3;
    }
    button {
        width: 100%;
        padding: 10px;
        background: #238636;
        border: none;
        border-radius: 6px;
        margin-top: 12px;
        color: white;
        font-weight: bold;
        cursor: pointer;
    }
    button:hover {
        background: #2ea043;
    }
    #output {
        flex: 1;
        white-space: pre-wrap;
        background: #0d1117;
        border: 1px solid #30363d;
        padding: 10px;
        margin-top: 10px;
        border-radius: 6px;
        overflow-y: auto;
    }
</style>
</head>
<body>

<div id="leftPanel">
    <div class="sectionTitle">Match Input</div>

    <label>Expected Goals (Home)</label>
    <input id="xg_home" type="number" step="0.01">

    <label>Expected Goals (Away)</label>
    <input id="xg_away" type="number" step="0.01">

    <label>Shots (Home)</label>
    <input id="shots_home" type="number">

    <label>Shots (Away)</label>
    <input id="shots_away" type="number">

    <label>SOT (Home)</label>
    <input id="sot_home" type="number">

    <label>SOT (Away)</label>
    <input id="sot_away" type="number">

    <label>Preset Liga</label>
<select id="league_preset">
  <option value="AUTO">Auto Detect</option>

  <optgroup label="Top Leagues">
    <option value="EPL">Premier League (ENG)</option>
    <option value="LALIGA">La Liga (ESP)</option>
    <option value="SERIEA">Serie A (ITA)</option>
    <option value="BUNDES">Bundesliga (GER)</option>
    <option value="LIGUE1">Ligue 1 (FRA)</option>
  </optgroup>

  <optgroup label="Secondary">
    <option value="EREDIV">Eredivisie</option>
    <option value="PRIMEIRA">Primeira Liga</option>
    <option value="MLS">MLS</option>
  </optgroup>

  <optgroup label="Cups / International">
    <option value="UCL">Champions League</option>
    <option value="UEL">Europa League</option>
    <option value="INT">International Match</option>
  </optgroup>
</select>

    <label>Possession Home (%)</label>
    <input id="pos_home" type="number">

    <label>Importance (1–10)</label>
    <input id="importance" type="number" min="1" max="10">

    <div class="sectionTitle">Match Type (57 Types)</div>
    <select id="match_type">
        <!-- Will be filled in PART 2 -->
    </select>

    <button id="runEngine">RUN ANALYSIS</button>
</div>

<div id="rightPanel">
    <div class="sectionTitle">PSZ LEVEL 1500 — RESULT</div>
    <div id="output">Waiting for input…</div>
</div>
<script>
/* =====================================
   PART 1 – CORE NAMESPACE & GUARD
   PSZ LEVEL 1500
===================================== */
(function(){
  if(!window.PSZ) window.PSZ = {};
  const PSZ = window.PSZ;

  PSZ.guard = function(cond, msg){
    if(!cond) throw new Error(msg || "PSZ Guard failed");
  };

  PSZ.safeNum = function(v, d=0){
    v = Number(v);
    return Number.isFinite(v) ? v : d;
  };

  PSZ.clamp = function(v, min, max){
    v = Number(v);
    if(!Number.isFinite(v)) v = min;
    if(min !== undefined) v = Math.max(min, v);
    if(max !== undefined) v = Math.min(max, v);
    return v;
  };

  console.log("PART 1 loaded: Core Namespace & Guard");
})();
</script>
<script>
/* =====================================
   PART 2 — LEAGUE PRESET REGISTRY
   PSZ LEVEL 1500 (SAFE)
===================================== */

(function () {
  const PSZ = window.PSZ = window.PSZ || {};

  /* ---------- DEFAULT AUTO ---------- */
  PSZ.LEAGUE_PRESETS = {
    AUTO: {
      name: "Auto Detect",
      tempo: 5.0,
      volatility: 0.50,
      overBias: 0.00,
      bttsBias: 0.00,
      riskMod: 0.00,
      confMin: 60,
      noBetStrict: false
    },

    /* ---------- TOP LEAGUES ---------- */
    EPL: {
      name: "Premier League (ENG)",
      tempo: 6.8,
      volatility: 0.65,
      overBias: 0.10,
      bttsBias: 0.08,
      riskMod: 0.05,
      confMin: 55
    },

    LALIGA: {
      name: "La Liga (ESP)",
      tempo: 6.2,
      volatility: 0.55,
      overBias: -0.05,
      bttsBias: -0.02,
      riskMod: -0.05,
      confMin: 60
    },

    SERIEA: {
      name: "Serie A (ITA)",
      tempo: 5.8,
      volatility: 0.50,
      overBias: -0.10,
      bttsBias: -0.08,
      riskMod: -0.10,
      confMin: 62
    },

    BUNDES: {
      name: "Bundesliga (GER)",
      tempo: 6.6,
      volatility: 0.70,
      overBias: 0.15,
      bttsBias: 0.10,
      riskMod: 0.10,
      confMin: 55
    },

    LIGUE1: {
      name: "Ligue 1 (FRA)",
      tempo: 5.9,
      volatility: 0.55,
      overBias: -0.05,
      bttsBias: -0.03,
      riskMod: -0.05,
      confMin: 60
    },

    /* ---------- INTERNATIONAL / CUPS ---------- */
    UCL: {
      name: "Champions League",
      tempo: 5.6,
      volatility: 0.45,
      overBias: -0.15,
      bttsBias: -0.10,
      riskMod: -0.20,
      confMin: 65,
      noBetStrict: true
    },

    UEL: {
      name: "Europa League",
      tempo: 5.9,
      volatility: 0.55,
      overBias: -0.05,
      bttsBias: -0.03,
      riskMod: -0.10,
      confMin: 60
    },

    INT: {
      name: "International Match",
      tempo: 5.0,
      volatility: 0.40,
      overBias: -0.20,
      bttsBias: -0.15,
      riskMod: -0.25,
      confMin: 70,
      noBetStrict: true
    }
  };

})();
</script>
<script>
/* =====================================
   PART 3 — AUTO CONTEXT BUILDER
   PSZ LEVEL 1500 (SAFE)
===================================== */

(function () {
  const PSZ = window.PSZ;
  PSZ.guard(PSZ, "PSZ not initialized (PART 3)");

  /* =====================================
     Build Context from UI
     ===================================== */
  PSZ.buildAutoContext = function () {

    /* ---------- Read UI (SAFE) ---------- */
    const leagueKey = document.getElementById("league_preset")?.value || "AUTO";
    const manualMatchType = document.getElementById("match_type")?.value || "AUTO";

    // Core inputs (engine ASLI)
    const homeStrength = PSZ.safeNum(
      document.getElementById("homeStrength")?.value,
      5
    );
    const awayStrength = PSZ.safeNum(
      document.getElementById("awayStrength")?.value,
      5
    );
    const importance = PSZ.safeNum(
      document.getElementById("importance")?.value,
      5
    );
    const tempoInput = PSZ.safeNum(
      document.getElementById("tempo")?.value,
      5
    );

    /* ---------- Resolve League ---------- */
    const L = PSZ.resolveLeaguePreset(leagueKey);

    /* ---------- Build Context ---------- */
    const ctx = {
      /* ----- Base (ENGINE CORE) ----- */
      base: {
        strHome: PSZ.clamp(homeStrength, 1, 9),
        strAway: PSZ.clamp(awayStrength, 1, 9),
        imp: PSZ.clamp(importance, 1, 10),

        // Flags (dipakai match type)
        isFinal: importance >= 9,
        isCup: ["UCL", "UEL", "INT"].includes(leagueKey),
        relegationPressure:
          importance >= 8 &&
          Math.abs(homeStrength - awayStrength) <= 1
      },

      /* ----- Auto-derived (ENGINE SUPPORT) ----- */
      auto: {
        tempo: PSZ.clamp(
          (tempoInput + PSZ.safeNum(L.tempo, 5)) / 2,
          3,
          8
        ),
        volatility: PSZ.clamp(
          PSZ.safeNum(L.volatility, 0.5),
          0.30,
          0.85
        ),
        risk: 0
      },

      /* ----- Meta ----- */
      leaguePreset: leagueKey,
      manualMatchType: manualMatchType,

      /* ----- Match Type (diisi PART 7) ----- */
      matchType: "LEAGUE_REGULAR",
      matchTypeReason: [],

      /* ----- Modifiers (dipakai belakangan) ----- */
      leagueRiskMod: PSZ.safeNum(L.riskMod, 0),
      matchRisk: 0,
      matchConfMod: 0
    };

    return ctx;
  };

  console.log("PART 3 loaded: Auto Context Builder");
})();
</script>
<script>
/* =====================================
   PART 4 — CORE ENGINE DERIVATION
   PSZ LEVEL 1500 (SAFE)
===================================== */

(function () {
  const PSZ = window.PSZ;
  PSZ.guard(PSZ, "PSZ not initialized (PART 4)");

  /* =====================================
     Derive Core Engine Parameters
     ===================================== */
  PSZ.deriveCoreEngine = function (ctx) {
    PSZ.guard(ctx && ctx.base && ctx.auto, "Invalid ctx (PART 4)");

    /* ---------- Base Strength ---------- */
    const strH = ctx.base.strHome;
    const strA = ctx.base.strAway;

    /* ---------- Tempo ---------- */
    const tempo = ctx.auto.tempo; // 3–8 (dari PART 3)

    /* ---------- Importance Modifier ---------- */
    const imp = ctx.base.imp; // 1–10

    /* ---------- Fatigue / Pressure ---------- */
    // Filosofi lama: importance tinggi = lebih hati-hati
    const fatigueMod = imp >= 8 ? -0.08 : 0;

    /* ---------- Lambda Calculation (ENGINE ASLI) ---------- */
    let lambdaHome =
      0.9 +
      strH * 0.28 +
      (tempo - 5) * 0.15 +
      fatigueMod;

    let lambdaAway =
      0.9 +
      strA * 0.28 +
      (tempo - 5) * 0.15 +
      fatigueMod;

    /* ---------- Clamp Lambda ---------- */
    lambdaHome = PSZ.clamp(lambdaHome, 0.2, 3.8);
    lambdaAway = PSZ.clamp(lambdaAway, 0.2, 3.8);

    /* ---------- fxG (Expected Total Goals) ---------- */
    const fxG = PSZ.clamp(lambdaHome + lambdaAway, 0.5, 6.0);

    /* ---------- Save to Context ---------- */
    ctx.engine = {
      lambdaHome,
      lambdaAway,
      fxG,
      tempo,
      fatigueMod
    };

    return ctx;
  };

  console.log("PART 4 loaded: Core Engine Derivation");
})();
</script>
<script>
/* =====================================
   PART 5 — MONTE CARLO ENGINE
   PSZ LEVEL 1500 (SAFE)
===================================== */

(function () {
  const PSZ = window.PSZ;
  PSZ.guard(PSZ, "PSZ not initialized (PART 5)");

  /* ---------- Poisson Sampler ---------- */
  function poisson(lambda) {
    let L = Math.exp(-lambda);
    let p = 1.0;
    let k = 0;
    do {
      k++;
      p *= Math.random();
    } while (p > L);
    return k - 1;
  }

  /* =====================================
     Run Monte Carlo Simulation
     ===================================== */
  PSZ.runMonteCarlo = function (ctx, opt) {
    PSZ.guard(ctx && ctx.engine, "Invalid ctx.engine (PART 5)");

    opt = opt || {};
    const N = PSZ.safeNum(opt.N, 8000);
    const CAP = PSZ.safeNum(opt.cap, 6);

    const λH = ctx.engine.lambdaHome;
    const λA = ctx.engine.lambdaAway;

    /* ---------- Init Matrix ---------- */
    const matrix = [];
    for (let h = 0; h <= CAP; h++) {
      matrix[h] = [];
      for (let a = 0; a <= CAP; a++) {
        matrix[h][a] = 0;
      }
    }

    /* ---------- Simulation ---------- */
    for (let i = 0; i < N; i++) {
      const h = Math.min(poisson(λH), CAP);
      const a = Math.min(poisson(λA), CAP);
      matrix[h][a]++;
    }

    /* ---------- Meta Stats ---------- */
    let sumGoals = 0;
    let bttsYes = 0;

    for (let h = 0; h <= CAP; h++) {
      for (let a = 0; a <= CAP; a++) {
        const c = matrix[h][a];
        sumGoals += (h + a) * c;
        if (h > 0 && a > 0) bttsYes += c;
      }
    }

    const res = {
      matrix,
      meta: {
        N,
        CAP,
        lambdaHome: λH,
        lambdaAway: λA,
        avgGoals: sumGoals / N
      },
      probs: {
        bttsYes: bttsYes / N
      }
    };

    return res;
  };

  console.log("PART 5 loaded: Monte Carlo Engine");
})();
</script>
<script>
/* =====================================
   PART 6 — OVER / UNDER ENGINE
   PSZ LEVEL 1500 (SAFE)
===================================== */

(function () {
  const PSZ = window.PSZ;
  PSZ.guard(PSZ, "PSZ not initialized (PART 6)");

  /* =====================================
     Compute Over / Under Probabilities
     ===================================== */
  PSZ.computeOU = function (res) {
    PSZ.guard(res && res.matrix && res.meta, "Invalid res (PART 6)");

    const matrix = res.matrix;
    const CAP = res.meta.CAP;
    const N = res.meta.N;

    const lines = [0.5, 1.5, 2.5, 3.5];
    const out = {};

    lines.forEach(line => {
      const cut = Math.floor(line);
      let underCount = 0;

      for (let h = 0; h <= CAP; h++) {
        for (let a = 0; a <= CAP; a++) {
          if (h + a <= cut) {
            underCount += matrix[h][a];
          }
        }
      }

      const underProb = underCount / N;
      out[line] = {
        under: underProb,
        over: 1 - underProb
      };
    });

    return out;
  };

  console.log("PART 6 loaded: Over/Under Engine");
})();
</script>
<script>
/* =====================================
   PART 7 — MATCH TYPE CLASSIFIER
   PSZ LEVEL 1500 (SAFE)
===================================== */

(function () {
  const PSZ = window.PSZ;
  PSZ.guard(PSZ, "PSZ not initialized (PART 7)");

  /* =====================================
     Apply Match Type Classification
     ===================================== */
  PSZ.applyMatchType = function (ctx) {
    PSZ.guard(ctx && ctx.base, "Invalid ctx (PART 7)");

    // Reset
    ctx.matchType = "LEAGUE_REGULAR";
    ctx.matchTypeReason = [];
    ctx.matchRisk = 0;
    ctx.matchConfMod = 0;

    /* ---------- Manual Override ---------- */
    if (ctx.manualMatchType && ctx.manualMatchType !== "AUTO") {
      ctx.matchType = ctx.manualMatchType;
      ctx.matchTypeReason.push("Manual match type selected");
      return ctx;
    }

    const imp = ctx.base.imp;
    const strengthDiff = Math.abs(ctx.base.strHome - ctx.base.strAway);

    /* ---------- Final / Title Decider ---------- */
    if (ctx.base.isFinal) {
      ctx.matchType = "FINAL";
      ctx.matchTypeReason.push("High importance final");
      ctx.matchRisk += 0.20;
      ctx.matchConfMod -= 8;
      return ctx;
    }

    /* ---------- Cup Knockout ---------- */
    if (ctx.base.isCup) {
      ctx.matchType = "CUP_KNOCKOUT";
      ctx.matchTypeReason.push("Cup knockout match");
      ctx.matchRisk += 0.10;
      ctx.matchConfMod -= 4;
      return ctx;
    }

    /* ---------- Derby / Big Match ---------- */
    if (imp >= 7 && strengthDiff <= 1) {
      ctx.matchType = "DERBY";
      ctx.matchTypeReason.push("High-profile derby / big match");
      ctx.matchRisk += 0.15;
      ctx.matchConfMod -= 6;
      return ctx;
    }

    /* ---------- Relegation Battle ---------- */
    if (ctx.base.relegationPressure) {
      ctx.matchType = "RELEGATION";
      ctx.matchTypeReason.push("Relegation battle");
      ctx.matchRisk += 0.12;
      ctx.matchConfMod -= 5;
      return ctx;
    }

    // Default stays LEAGUE_REGULAR
    ctx.matchTypeReason.push("Regular league match");
    return ctx;
  };

  console.log("PART 7 loaded: Match Type Classifier");
})();
</script>
<script>
/* =====================================
   PART 8 — CONFIDENCE & RECOMMENDATION
   PSZ LEVEL 1500 (SAFE)
===================================== */

(function () {
  const PSZ = window.PSZ;
  PSZ.guard(PSZ, "PSZ not initialized (PART 8)");

  /* =====================================
     Compute Confidence
     ===================================== */
  PSZ.computeConfidence = function (ctx, res, ou) {
    PSZ.guard(ctx && res && ou, "Invalid input (computeConfidence)");

    // Base confidence from strongest market edge
    let conf = Math.max(
      ou[2.5].over,
      ou[2.5].under
    ) * 100;

    // Penalize volatility
    conf -= ctx.auto.volatility * 15;

    // Penalize match type risk
    conf += PSZ.safeNum(ctx.matchConfMod, 0);

    return PSZ.clamp(conf, 5, 95);
  };

  /* =====================================
     Build Initial Recommendation
     ===================================== */
  PSZ.buildRecommendation = function (ctx, res, ou, conf) {
    PSZ.guard(ctx && res && ou, "Invalid input (buildRecommendation)");

    let rec = {
      result: "NO BET",
      goals: "NO BET",
      btts: "NO BET"
    };

    // Goals market
    if (ou[2.5].over >= 0.55) {
      rec.goals = "OVER 2.5";
      rec.result = "PLAY";
    } else if (ou[2.5].under >= 0.60) {
      rec.goals = "UNDER 2.5";
      rec.result = "PLAY";
    }

    // BTTS (optional, conservative)
    if (res.probs && res.probs.bttsYes >= 0.60) {
      rec.btts = "YES";
    }

    return rec;
  };

  /* =====================================
     Apply Final NO BET Gate
     ===================================== */
  PSZ.applyFinalNoBetGate = function (ctx, rec, conf) {
    PSZ.guard(ctx && rec, "Invalid input (applyFinalNoBetGate)");

    const L = PSZ.resolveLeaguePreset(ctx.leaguePreset);
    const minConf = PSZ.safeNum(L.confMin, 60);

    let reasons = [];

    if (conf < minConf) {
      reasons.push("Confidence below minimum");
    }

    if (ctx.matchRisk >= 0.20) {
      reasons.push("High match risk");
    }

    if (L.noBetStrict && conf < minConf + 5) {
      reasons.push("Strict league rules");
    }

    if (reasons.length > 0) {
      return {
        result: "NO BET",
        goals: "NO BET",
        btts: "NO BET",
        noBetReasons: reasons
      };
    }

    return rec;
  };

  console.log("PART 8 loaded: Confidence & Recommendation");
})();
</script>
<script>
/* =====================================
   PART 9 — OUTPUT BUILDER + RUN BINDING
   PSZ LEVEL 1500 (SAFE)
===================================== */

(function () {
  const PSZ = window.PSZ;
  PSZ.guard(PSZ, "PSZ not initialized (PART 9)");

  /* =====================================
     Build Output Text
     ===================================== */
  PSZ.buildOutputText = function (ctx, res, ou, conf, rec) {
    PSZ.guard(ctx && res && ou && rec, "Invalid data (buildOutputText)");

    let t = "";
    t += "PSZ LEVEL 1500 — ANALYSIS RESULT\n";
    t += "--------------------------------\n";

    t += `League Preset : ${ctx.leaguePreset}\n`;
    t += `Match Type    : ${ctx.matchType}\n`;
    if (ctx.matchTypeReason && ctx.matchTypeReason.length) {
      t += `Reason        : ${ctx.matchTypeReason.join(", ")}\n`;
    }

    t += "\n[ENGINE]\n";
    t += `λ Home        : ${ctx.engine.lambdaHome.toFixed(2)}\n`;
    t += `λ Away        : ${ctx.engine.lambdaAway.toFixed(2)}\n`;
    t += `Expected G    : ${ctx.engine.fxG.toFixed(2)}\n`;

    t += "\n[OVER / UNDER]\n";
    Object.keys(ou).forEach(line => {
      const o = ou[line];
      t += `O/U ${line} | Over ${(o.over * 100).toFixed(1)}% | Under ${(o.under * 100).toFixed(1)}%\n`;
    });

    t += "\n[CONFIDENCE]\n";
    t += `Confidence    : ${conf.toFixed(1)}%\n`;

    t += "\n[RECOMMENDATION]\n";
    t += `Result        : ${rec.result}\n`;
    t += `Goals         : ${rec.goals}\n`;
    t += `BTTS          : ${rec.btts}\n`;

    if (rec.noBetReasons && rec.noBetReasons.length) {
      t += "\n[NO BET REASONS]\n";
      rec.noBetReasons.forEach(r => {
        t += `- ${r}\n`;
      });
    }

    return t;
  };

  /* =====================================
     Run Full Analysis Pipeline
     ===================================== */
  PSZ.runAnalysis = function () {
    const out = document.getElementById("output");
    if (!out) return;

    out.textContent = "Running analysis...\n";

    try {
      // PART 3
      let ctx = PSZ.buildAutoContext();

      // PART 4
      ctx = PSZ.deriveCoreEngine(ctx);

      // PART 7
      ctx = PSZ.applyMatchType(ctx);

      // PART 5
      const res = PSZ.runMonteCarlo(ctx, { N: 8000, cap: 6 });

      // PART 6
      const ou = PSZ.computeOU(res);

      // PART 8
      const conf = PSZ.computeConfidence(ctx, res, ou);
      let rec = PSZ.buildRecommendation(ctx, res, ou, conf);
      rec = PSZ.applyFinalNoBetGate(ctx, rec, conf);

      // OUTPUT
      out.textContent = PSZ.buildOutputText(ctx, res, ou, conf, rec);

    } catch (e) {
      out.textContent = "ERROR:\n" + (e.message || e);
      console.error("[PSZ ERROR]", e);
    }
  };

  /* =====================================
     Bind Run Button
     ===================================== */
  document.addEventListener("DOMContentLoaded", function () {
    const btn = document.getElementById("runEngine");
    if (!btn) {
      console.warn("Run button not found");
      return;
    }
    btn.addEventListener("click", PSZ.runAnalysis);
  });

  console.log("PART 9 loaded: Output Builder + Run Binding");
})();
</script>
</body>
</html>
